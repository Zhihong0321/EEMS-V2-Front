"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[658],{71658:function(e,t,a){a.d(t,{DashboardContent:function(){return D}});var s=a(57437),l=a(2265),r=a(87138),n=a(92566),i=a(27561),c=a(16638),d=a(86991),o=a(92893),m=a(35231),x=a(54142),u=a(2842),h=a(9542),p=a(85475);let g=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kuala_Lumpur"}),b=new Intl.NumberFormat(void 0,{maximumFractionDigits:2});function f(e){var t,a;let{block:l,loading:r,targetKwh:f,mode:v}=e,N=null!==(t=null!=f?f:null==l?void 0:l.target_kwh)&&void 0!==t?t:0,k=(()=>{if(l){let e=new Date(l.block_start_local),t=new Date(e.getTime()+18e5);return{startTs:e.getTime(),endTs:t.getTime()}}let e=new Date,t=e.getMinutes(),a=new Date(e);a.setMinutes(30*Math.floor(t/30),0,0);let s=new Date(a.getTime()+18e5);return{startTs:a.getTime(),endTs:s.getTime()}})(),w=function(e,t){try{let a=new Date(e),s=new Date(t);return"".concat(g.format(a)," – ").concat(g.format(s))}catch(e){return"Invalid time range"}}(k.startTs,k.endTs),{data:y,startTs:_,endTs:D,binSeconds:T}=function(e,t,a){var s,l,r,n;let{startTs:i,endTs:c}=a;if(!(e&&new Date(e.block_start_local).getTime()===i))return{data:Array(60).fill(null).map((e,t)=>({ts:i+(t+1)*3e4,value:0})),startTs:i,endTs:c,binSeconds:30};let d=null!==(r=null===(s=e.chart_bins)||void 0===s?void 0:s.points)&&void 0!==r?r:[],o=null!==(n=null===(l=e.chart_bins)||void 0===l?void 0:l.bin_seconds)&&void 0!==n?n:30,m=[];return m="accumulate"===t?d.map((e,t)=>({ts:i+(t+1)*o*1e3,value:e})):d.map((e,t)=>({ts:i+(t+1)*o*1e3,value:e-(0===t?0:d[t-1])})),{data:Array(Math.floor(1800/o)).fill(null).map((e,t)=>{let a=i+(t+1)*o*1e3,s=m.find(e=>e.ts===a);return null!=s?s:{ts:a,value:0}}),startTs:i,endTs:c,binSeconds:o}}(l,v,k),F="accumulate"===v,A=F?n.w:i.T,S=F?(0,s.jsx)(c.x,{type:"monotone",dataKey:"value",stroke:"#22d3ee",strokeWidth:2,dot:!1,isAnimationActive:!1}):(0,s.jsx)(d.u,{type:"monotone",dataKey:"value",stroke:"#22d3ee",fill:"#22d3ee",fillOpacity:.3,isAnimationActive:!1}),C=F?(0,s.jsx)(o.d,{y:N,stroke:"#f97316",strokeDasharray:"6 6"}):null;return(0,s.jsxs)("article",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,s.jsxs)("header",{className:"mb-6 flex flex-wrap items-end justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-white",children:"Current 30-minute block"}),(0,s.jsxs)("p",{className:"text-sm text-slate-400",children:["Window ",w]})]}),(0,s.jsxs)("div",{className:"rounded-md border border-slate-800 px-4 py-2 text-xs text-slate-400",children:["Target ",N.toFixed(1)," kWh \xb7 Accumulated ",null!==(a=null==l?void 0:l.accumulated_kwh.toFixed(2))&&void 0!==a?a:"—"," kWh"]})]}),(0,s.jsx)("div",{className:"h-72 w-full",children:r?(0,s.jsx)("div",{className:"flex h-full items-center justify-center rounded-xl border border-dashed border-slate-800 bg-slate-950/40",children:(0,s.jsx)("span",{className:"text-sm text-slate-500",children:"Loading chart…"})}):0===y.length?(0,s.jsx)("div",{className:"flex h-full items-center justify-center rounded-xl border border-dashed border-slate-800 bg-slate-950/40",children:(0,s.jsx)("span",{className:"text-sm text-slate-500",children:"No readings for this block yet."})}):(0,s.jsx)(m.h,{width:"100%",height:"100%",children:(0,s.jsxs)(A,{data:y,margin:{left:12,right:12,top:12,bottom:12},children:[(0,s.jsx)(x.q,{strokeDasharray:"4 4",stroke:"#1f2937"}),(0,s.jsx)(u.K,{dataKey:"ts",type:"number",domain:[_,D],tickFormatter:e=>g.format(e),stroke:"#64748b",tickLine:!1}),(0,s.jsx)(h.B,{dataKey:"value",stroke:"#64748b",tickLine:!1,width:60,tickFormatter:e=>b.format(e)}),(0,s.jsx)(p.u,{content:(0,s.jsx)(j,{target:N,mode:v,binSeconds:T})}),C,S]})})}),(0,s.jsx)("p",{className:"mt-4 text-xs text-slate-500",children:"Streaming series updates replace the entire 60-point window whenever the backend publishes a block update."})]})}function j(e){var t,a;let{active:l,payload:r,label:n,target:i,mode:c,binSeconds:d}=e;if(!l||!r||0===r.length||!n)return null;let o=null!==(a=null===(t=r[0])||void 0===t?void 0:t.value)&&void 0!==a?a:0,m=i>0?(o/i*100).toFixed(1):"0",x=g.format(n);return(0,s.jsxs)("div",{className:"rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-xs text-slate-200 shadow-lg",children:[(0,s.jsxs)("p",{className:"font-semibold",children:[x," \xb7 ",b.format(o)," kWh"]}),(0,s.jsxs)("p",{className:"text-slate-400",children:["accumulate"===c?"Accumulated":"Usage per ".concat(d,"s")," \xb7 ",m,"% of target"]})]})}let v=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kuala_Lumpur"});function N(e){let{history:t,loading:a}=e;return(0,s.jsxs)("article",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-white",children:"History (last 10 blocks)"}),a?(0,s.jsx)("ul",{className:"mt-4 space-y-3",children:Array.from({length:4}).map((e,t)=>(0,s.jsx)("li",{className:"h-12 animate-pulse rounded-md bg-slate-800/40"},t))}):0===t.length?(0,s.jsx)("p",{className:"mt-4 text-sm text-slate-400",children:"No block history yet. Run the simulator to populate readings."}):(0,s.jsx)("ul",{className:"mt-4 space-y-3",children:t.map((e,t)=>{let a=e.percent_of_target,l="";try{let t=new Date(e.block_start_local),a=new Date(t.getTime()+18e5);l="".concat(v.format(t)," – ").concat(v.format(a))}catch(t){l=e.block_start_local}return(0,s.jsxs)("li",{className:"flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/60 px-4 py-3 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-slate-100",children:l}),(0,s.jsxs)("p",{className:"text-xs text-slate-500",children:[e.accumulated_kwh.toFixed(2)," / ",e.target_kwh.toFixed(1)," kWh"]})]}),(0,s.jsxs)("span",{className:"text-sm font-semibold ".concat(a>100?"text-danger":a>=80?"text-warning":"text-success"),children:[a.toFixed(1),"%"]})]},"".concat(e.block_start_local,"-").concat(t))})})]})}let k=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Kuala_Lumpur"});function w(e){let{connected:t,reconnecting:a,lastReadingTs:l,simulatorId:r}=e,n="bg-slate-500",i="Disconnected";t?(n="bg-emerald-400 animate-pulse",i="Connected"):a&&(n="bg-amber-400 animate-pulse",i="Reconnecting");let c=l?k.format(new Date(l)):"—";return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-white",children:"Live status"}),(0,s.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[(0,s.jsx)("span",{className:"h-3 w-3 rounded-full ".concat(n),"aria-hidden":"true"}),(0,s.jsx)("span",{className:"text-sm text-slate-200",children:i})]}),(0,s.jsxs)("dl",{className:"mt-4 space-y-2 text-xs text-slate-400",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("dt",{className:"uppercase tracking-[0.2em] text-slate-500",children:"Last reading"}),(0,s.jsx)("dd",{className:"mt-1 text-sm text-slate-200",children:c})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("dt",{className:"uppercase tracking-[0.2em] text-slate-500",children:"SSE endpoint"}),(0,s.jsxs)("dd",{className:"mt-1 text-sm text-slate-200",children:["/api/v1/stream/",null!=r?r:"<id>"]})]})]})]})}var y=a(81622);let _=new Intl.NumberFormat(void 0,{maximumFractionDigits:1});function D(e){var t;let{simulatorId:a,simulatorName:n,targetKwh:i,initialBlock:c,initialHistory:d}=e,[o,m]=(0,l.useState)("accumulate"),{history:x,loading:u,refresh:h}=(0,y.NX)(a,10,d),p=(0,l.useCallback)(()=>{h()},[h]),{block:g,loading:b,connected:j,reconnecting:v,lastReadingTs:k,refresh:D}=(0,y.AF)(a,{onWindowChange:p},c),T=null!==(t=null==g?void 0:g.percent_of_target)&&void 0!==t?t:0,F=T>100?"text-danger":T>=80?"text-warning":"text-success";return(0,s.jsxs)("section",{className:"space-y-10",children:[(0,s.jsxs)("header",{className:"flex flex-wrap items-end justify-between gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-500",children:"Simulator"}),(0,s.jsx)("h1",{className:"text-3xl font-semibold text-white",children:n}),(0,s.jsx)("p",{className:"text-sm text-slate-400",children:"Live chart and block history update in real time via server-sent events from the backend."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4 text-sm text-slate-300",children:[(0,s.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Target"}),(0,s.jsx)("p",{className:"text-base font-semibold text-slate-100",children:i?"".concat(i.toFixed(1)," kWh"):"—"})]}),(0,s.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Current block"}),(0,s.jsxs)("p",{className:"text-base font-semibold ".concat(F),children:[_.format(T),"%"]})]}),(0,s.jsx)(r.default,{href:{pathname:"/sim/[id]/run",query:{id:a}},className:"inline-flex items-center rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground transition hover:bg-cyan-600",children:"Open controls"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("label",{className:"text-sm text-slate-300",children:"Chart Mode:"}),(0,s.jsxs)("select",{value:o,onChange:e=>m(e.target.value),className:"rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100",children:[(0,s.jsx)("option",{value:"accumulate",children:"Accumulate"}),(0,s.jsx)("option",{value:"non-accumulate",children:"Non-Accumulate (Raw Readings)"})]})]})]}),(0,s.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[2fr,1fr]",children:[(0,s.jsx)(f,{block:null!=g?g:{simulator_id:a,block_start_local:new Date().toISOString(),block_start_utc:new Date().toISOString(),block_end_utc:new Date().toISOString(),target_kwh:null!=i?i:0,accumulated_kwh:0,percent_of_target:0,alerted_80pct:!1,chart_bins:{bin_seconds:30,points:[]}},loading:b,targetKwh:i,mode:o}),(0,s.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,s.jsx)(w,{connected:j,reconnecting:v,lastReadingTs:k,simulatorId:a}),(0,s.jsx)(N,{history:x,loading:u})]})]}),(0,s.jsxs)("p",{className:"text-xs text-slate-500",children:["Timezone reference: ","Asia/Kuala_Lumpur",". SSE events automatically trigger a history refresh when the backend rolls to a new block."]})]})}}}]);