(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{28297:function(e,t,n){Promise.resolve().then(n.bind(n,73373))},73373:function(e,t,n){"use strict";n.d(t,{default:function(){return m}});var a=n(57437),r=n(2265),i=n(87138),s=n(39514),l=n(32876),o=n(15597),c=n(81622);let u=new Intl.NumberFormat(void 0,{maximumFractionDigits:1});function d(e){var t;let{simulatorId:n,simulatorName:d,targetKwh:m,initialBlock:h,initialHistory:f}=e,[x,v]=(0,r.useState)("accumulate"),{history:p,loading:g,refresh:y}=(0,c.NX)(n,10,f),w=(0,r.useCallback)(()=>{y()},[y]),{block:b,loading:N,connected:_,reconnecting:j,lastReadingTs:E,refresh:k}=(0,c.AF)(n,{onWindowChange:w},h);(0,r.useEffect)(()=>{E&&"non-accumulate"===x&&k()},[E,k,x]),(0,r.useEffect)(()=>{let e=setInterval(()=>{k()},15e3);return()=>clearInterval(e)},[k]);let C=null!==(t=null==b?void 0:b.percent_of_target)&&void 0!==t?t:0,S=C>100?"text-danger":C>=80?"text-warning":"text-success";return(0,a.jsxs)("section",{className:"space-y-10",children:[(0,a.jsxs)("header",{className:"flex flex-wrap items-end justify-between gap-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-500",children:"Simulator"}),(0,a.jsx)("h1",{className:"text-3xl font-semibold text-white",children:d}),(0,a.jsx)("p",{className:"text-sm text-slate-400",children:"Live chart and block history update in real time via server-sent events from the backend."})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm text-slate-300",children:[(0,a.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[(0,a.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Target"}),(0,a.jsx)("p",{className:"text-base font-semibold text-slate-100",children:m?"".concat(m.toFixed(1)," kWh"):"â€”"})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[(0,a.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Current block"}),(0,a.jsxs)("p",{className:"text-base font-semibold ".concat(S),children:[u.format(C),"%"]})]}),(0,a.jsx)(i.default,{href:{pathname:"/sim/[id]/run",query:{id:n}},className:"inline-flex items-center rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground transition hover:bg-cyan-600",children:"Open controls"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("label",{className:"text-sm text-slate-300",children:"Chart Mode:"}),(0,a.jsxs)("select",{value:x,onChange:e=>v(e.target.value),className:"rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100",children:[(0,a.jsx)("option",{value:"accumulate",children:"Accumulate"}),(0,a.jsx)("option",{value:"non-accumulate",children:"Non-Accumulate (Raw Readings)"})]})]})]}),(0,a.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[2fr,1fr]",children:[(0,a.jsx)(s.l,{block:null!=b?b:{simulator_id:n,block_start_local:new Date().toISOString(),block_start_utc:new Date().toISOString(),block_end_utc:new Date().toISOString(),target_kwh:null!=m?m:0,accumulated_kwh:0,percent_of_target:0,alerted_80pct:!1,chart_bins:{bin_seconds:30,points:[]}},loading:N,targetKwh:m,mode:x}),(0,a.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,a.jsx)(o.C,{connected:_,reconnecting:j,lastReadingTs:E,block:b,targetKwh:m}),(0,a.jsx)(l.J,{history:p,loading:g})]})]}),(0,a.jsxs)("p",{className:"text-xs text-slate-500",children:["Timezone reference: ","Asia/Kuala_Lumpur",". SSE events automatically trigger a history refresh when the backend rolls to a new block."]})]})}function m(e){var t,n,i;let{simulators:s,initialDataMap:l}=e,[o,c]=(0,r.useState)(null!==(n=null===(t=s[0])||void 0===t?void 0:t.id)&&void 0!==n?n:null);if(0===s.length)return(0,a.jsx)("div",{className:"flex flex-col items-center justify-center h-screen text-slate-400",children:(0,a.jsx)("p",{children:"No simulators available. Please create one first."})});let u=s.find(e=>e.id===o),m=null!==(i=l[null!=o?o:""])&&void 0!==i?i:{initialBlock:null,initialHistory:[],targetKwh:void 0};return(0,a.jsxs)("div",{className:"space-y-8",children:[(0,a.jsxs)("header",{className:"space-y-2",children:[(0,a.jsx)("h1",{className:"text-3xl font-semibold text-white",children:"EMS Dashboard"}),(0,a.jsx)("p",{className:"text-sm text-slate-400",children:"Select a meter to view its live chart and block history."})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("label",{htmlFor:"meter-select",className:"text-sm font-medium text-slate-300",children:"Select Meter:"}),(0,a.jsx)("select",{id:"meter-select",value:null!=o?o:"",onChange:e=>c(e.target.value),className:"rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100 focus:border-primary focus:outline-none",children:s.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.name," (Target: ",e.target_kwh," kWh)"]},e.id))})]}),u&&(0,a.jsx)(d,{simulatorId:o,simulatorName:u.name,targetKwh:m.targetKwh,initialBlock:m.initialBlock,initialHistory:m.initialHistory})]})}},89733:function(e,t,n){"use strict";n.d(t,{z:function(){return o}});var a=n(57437),r=n(2265),i=n(44839);let s={primary:"bg-primary text-white shadow-sm hover:bg-cyan-600 hover:shadow-md active:scale-95",secondary:"border border-slate-700 bg-transparent text-slate-200 hover:bg-slate-800 hover:border-slate-600",ghost:"hover:bg-slate-800/50 text-slate-300 hover:text-white",danger:"bg-danger text-white shadow-sm hover:bg-red-600 hover:shadow-md active:scale-95",success:"bg-success text-white shadow-sm hover:bg-green-600 hover:shadow-md active:scale-95"},l={sm:"px-3 py-1.5 text-xs min-h-[36px]",md:"px-4 py-2 text-sm min-h-[44px]",lg:"px-6 py-3 text-base min-h-[48px]"},o=(0,r.forwardRef)((e,t)=>{let{className:n,variant:r="primary",size:o="md",isLoading:c,children:u,disabled:d,...m}=e;return(0,a.jsxs)("button",{className:(0,i.Z)("inline-flex items-center justify-center gap-2 rounded-md font-semibold transition-all duration-150","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950","disabled:pointer-events-none disabled:opacity-50",s[r],l[o],n),ref:t,disabled:d||c,...m,children:[c&&(0,a.jsxs)("svg",{className:"h-4 w-4 animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","aria-hidden":"true",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,a.jsx)("span",{className:c?"opacity-70":"",children:u})]})});o.displayName="Button"},8374:function(e,t,n){"use strict";n.d(t,{$T:function(){return h},Dr:function(){return d},HM:function(){return v},Oz:function(){return x},Qu:function(){return g},tQ:function(){return y},w:function(){return p},wC:function(){return f},wE:function(){return m}});var a=n(20357);let r="eems.apiKeyOverride",i=[{name:"NEXT_PUBLIC_BACKEND_TOKEN",value:"01121000099"},{name:"NEXT_PUBLIC_BACKEND_WRITE_TOKEN",value:a.env.NEXT_PUBLIC_BACKEND_WRITE_TOKEN},{name:"NEXT_PUBLIC_BACKEND_KEY",value:a.env.NEXT_PUBLIC_BACKEND_KEY},{name:"NEXT_PUBLIC_BACKEND_API_KEY",value:a.env.NEXT_PUBLIC_BACKEND_API_KEY}],s=null,l=!1,o=!1;function c(){if(!l){l=!0;try{let e=window.localStorage.getItem(r);e&&(s=e,o=!0)}catch(e){}}}function u(){for(let e of i)if(e.value)return{name:e.name,value:e.value};return null}function d(){var e,t;return null!==(t=null===(e=u())||void 0===e?void 0:e.value)&&void 0!==t?t:""}function m(){var e,t;return null!==(t=null===(e=u())||void 0===e?void 0:e.name)&&void 0!==t?t:null}function h(){return c(),s}function f(){return c(),o&&!!s}function x(e,t){s=e.trim()||null,o=!!((null==t?void 0:t.persist)&&s);try{o&&s?window.localStorage.setItem(r,s):window.localStorage.removeItem(r)}catch(e){}}function v(){s=null,o=!1;try{window.localStorage.removeItem(r)}catch(e){}}function p(){return h()||d()}function g(){return p().length>0}function y(){return d().length>0}},92800:function(e,t,n){"use strict";n.d(t,{Aq:function(){return b},Bj:function(){return f},CT:function(){return r},LK:function(){return h},M8:function(){return w},Mf:function(){return x},QY:function(){return y},aj:function(){return p},b0:function(){return m},he:function(){return N},ji:function(){return v},lA:function(){return g}});var a=n(8374);let r="/api/bridge",i=new Set([429,500,502,503,504]);class s extends Error{constructor(e,t,n,a){super(e),this.status=t,this.code=n,this.details=a}}function l(e){if(!r)throw new s("Backend base URL is not configured.",0);return e.startsWith("http")?e:"".concat(r).concat(e)}async function o(e){let t=await e.text();if(t)try{return JSON.parse(t)}catch(t){throw new s("Invalid JSON response: ".concat(t.message),e.status)}}async function c(e){var t,n,a,r,i,l;let o;try{o=await e.clone().json()}catch(e){}if(!o)try{let t=await e.text();if(t)return new s(t,e.status)}catch(e){}let c=null!==(l=null!==(i=null!==(r=null==o?void 0:null===(t=o.error)||void 0===t?void 0:t.message)&&void 0!==r?r:null==o?void 0:o.message)&&void 0!==i?i:e.statusText)&&void 0!==l?l:"Request failed with status ".concat(e.status),u=null==o?void 0:null===(n=o.error)||void 0===n?void 0:n.code,d=null==o?void 0:null===(a=o.error)||void 0===a?void 0:a.details;if(o&&o.detail){d=o.detail;try{if(Array.isArray(o.detail)){let e=o.detail.map(e=>(null==e?void 0:e.msg)||(null==e?void 0:e.detail)||"Validation error").filter(Boolean);e.length>0&&(c=e.join("; "))}else"string"==typeof o.detail&&(c=o.detail)}catch(e){}}return new s(c,e.status,u,d)}function u(e){return new Promise(t=>setTimeout(t,e))}async function d(e,t){var n,a;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=l(e),m=null!==(n=r.retryDelays)&&void 0!==n?n:[],h=0,f=new Headers(null==t?void 0:t.headers);f.set("Accept","application/json");let x={...t,headers:f};for(;;)try{let e=await fetch(d,x);if(!e.ok){let t=await c(e);if(a=e.status,i.has(a)&&h<m.length){await u(m[h++]);continue}throw t}if(204===e.status)return;return await o(e)}catch(e){if(e instanceof s)throw e;if(h<m.length){await u(m[h++]);continue}throw e}}function m(e){let t=new Headers(null==e?void 0:e.headers);t.set("Content-Type","application/json");let n=(0,a.w)();return n?t.set("x-api-key",n):t.delete("x-api-key"),{...e,headers:t}}async function h(e,t){try{return await d(e,t)}catch(n){if(!(n instanceof s))return await d(e,t,{retryDelays:[500]});throw n}}function f(e){return l(e)}async function x(){var e;let t=await h("/api/v1/simulators");return Array.isArray(t)?t:null!==(e=t.data)&&void 0!==e?e:[]}async function v(e){let t=await d("/api/v1/simulators",m({method:"POST",body:JSON.stringify(e)}),{retryDelays:[500,1500,3500]});return"data"in t?t.data:t}async function p(e){console.log("deleteSimulator called with id:",e);try{await d("/api/v1/simulators/".concat(e),m({method:"DELETE"}),{retryDelays:[500,1500]}),console.log("deleteSimulator successful for id:",e)}catch(t){throw console.error("deleteSimulator error for id:",e,t),t}}async function g(e){return await h("/api/v1/blocks/latest?simulator_id=".concat(encodeURIComponent(e)))}async function y(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,a=await h("/api/v1/blocks/history?simulator_id=".concat(encodeURIComponent(e),"&limit=").concat(n));return Array.isArray(a)?a:null!==(t=a.data)&&void 0!==t?t:[]}async function w(e){await d("/api/v1/readings:ingest",m({method:"POST",body:JSON.stringify(e)}),{retryDelays:[500,1500,3500]})}async function b(e){try{let t=new Date().toISOString();await d("/api/v1/readings?simulator_id=".concat(encodeURIComponent(e),"&before=").concat(encodeURIComponent(t)),m({method:"DELETE"}),{retryDelays:[500,1500]})}catch(t){try{await d("/api/v1/simulators/".concat(encodeURIComponent(e),"/readings"),m({method:"DELETE"}),{retryDelays:[500,1500]})}catch(e){console.warn("Failed to delete future readings from backend:",t,e)}}}async function N(e){try{var t;let n=await g(e);if((null===(t=n.chart_bins)||void 0===t?void 0:t.points)&&n.chart_bins.points.length>0){let e=new Date(n.block_start_local),t=n.chart_bins.bin_seconds||30,a=n.chart_bins.points.length;return new Date(e.getTime()+a*t*1e3).toISOString()}return null}catch(e){return console.warn("Failed to fetch last reading timestamp:",e),null}}}},function(e){e.O(0,[462,740,622,555,971,23,744],function(){return e(e.s=28297)}),_N_E=e.O()}]);