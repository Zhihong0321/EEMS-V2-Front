"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[381],{87381:function(e,t,r){r.d(t,{O:function(){return A}}),(n=c||(c={})).WHATSAPP_API_UNAVAILABLE="WHATSAPP_API_UNAVAILABLE",n.INVALID_PHONE_NUMBER="INVALID_PHONE_NUMBER",n.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",n.STORAGE_ERROR="STORAGE_ERROR",n.VALIDATION_ERROR="VALIDATION_ERROR",n.DUPLICATE_TRIGGER="DUPLICATE_TRIGGER",n.COOLDOWN_ACTIVE="COOLDOWN_ACTIVE";let a={TRIGGERS:"notification_triggers",HISTORY:"notification_history",SETTINGS:"notification_settings",COOLDOWNS:"notification_cooldowns"},i={cooldownMinutes:15,maxDailyNotifications:10,enabledGlobally:!0};class o{safeParseJSON(e,t){try{let r=localStorage.getItem(e);if(null===r)return t;return JSON.parse(r)}catch(r){return console.error("Error parsing localStorage item ".concat(e,":"),r),t}}safeSaveJSON(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(t){throw console.error("Error saving to localStorage ".concat(e,":"),t),Error("Storage error: ".concat(t instanceof Error?t.message:"Unknown error"))}}generateId(){return"".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9))}async saveTrigger(e){let t=this.safeParseJSON(a.TRIGGERS,[]);if(t.find(t=>t.simulatorId===e.simulatorId&&t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage&&t.id!==e.id))throw Error("A trigger with the same simulator, phone number, and threshold already exists");let r=t.findIndex(t=>t.id===e.id);r>=0?t[r]=e:t.push(e),this.safeSaveJSON(a.TRIGGERS,t)}async getTrigger(e){return this.safeParseJSON(a.TRIGGERS,[]).find(t=>t.id===e)||null}async getTriggersBySimulator(e){return this.safeParseJSON(a.TRIGGERS,[]).filter(t=>t.simulatorId===e)}async getAllTriggers(){return this.safeParseJSON(a.TRIGGERS,[])}async updateTrigger(e,t){let r=this.safeParseJSON(a.TRIGGERS,[]),i=r.findIndex(t=>t.id===e);if(-1===i)throw Error("Trigger with id ".concat(e," not found"));r[i]={...r[i],...t,updatedAt:new Date().toISOString()},this.safeSaveJSON(a.TRIGGERS,r)}async deleteTrigger(e){let t=this.safeParseJSON(a.TRIGGERS,[]),r=t.filter(t=>t.id!==e);if(t.length===r.length)throw Error("Trigger with id ".concat(e," not found"));this.safeSaveJSON(a.TRIGGERS,r);let i=this.safeParseJSON(a.COOLDOWNS,{});delete i[e],this.safeSaveJSON(a.COOLDOWNS,i)}async saveNotificationHistory(e){let t=this.safeParseJSON(a.HISTORY,[]);t.push(e),t.length>1e3&&t.splice(0,t.length-1e3),this.safeSaveJSON(a.HISTORY,t)}async getNotificationHistory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return this.safeParseJSON(a.HISTORY,[]).filter(t=>t.simulatorId===e).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,t)}async getAllNotificationHistory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;return this.safeParseJSON(a.HISTORY,[]).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,e)}async getSettings(){return this.safeParseJSON(a.SETTINGS,i)}async updateSettings(e){let t={...await this.getSettings(),...e};this.safeSaveJSON(a.SETTINGS,t)}async getLastNotificationTime(e){let t=this.safeParseJSON(a.COOLDOWNS,{})[e];return t?new Date(t):null}async setLastNotificationTime(e,t){let r=this.safeParseJSON(a.COOLDOWNS,{});r[e]=t.toISOString(),this.safeSaveJSON(a.COOLDOWNS,r)}async clearAllData(){Object.values(a).forEach(e=>{localStorage.removeItem(e)})}async exportData(){return JSON.stringify({triggers:this.safeParseJSON(a.TRIGGERS,[]),history:this.safeParseJSON(a.HISTORY,[]),settings:this.safeParseJSON(a.SETTINGS,i),cooldowns:this.safeParseJSON(a.COOLDOWNS,{}),exportedAt:new Date().toISOString()},null,2)}async importData(e){try{let t=JSON.parse(e);t.triggers&&this.safeSaveJSON(a.TRIGGERS,t.triggers),t.history&&this.safeSaveJSON(a.HISTORY,t.history),t.settings&&this.safeSaveJSON(a.SETTINGS,t.settings),t.cooldowns&&this.safeSaveJSON(a.COOLDOWNS,t.cooldowns)}catch(e){throw Error("Invalid import data: ".concat(e instanceof Error?e.message:"Unknown error"))}}}function s(e,t,r,a){return{id:"history-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),triggerId:e.id,simulatorId:e.simulatorId,phoneNumber:e.phoneNumber,thresholdPercentage:e.thresholdPercentage,actualPercentage:t,sentAt:new Date().toISOString(),success:r,errorMessage:a}}new o;var n,c,l=r(18910),g=r(61233);class h extends Error{constructor(e,t,r){super(t),this.name="NotificationValidationError",this.type=e,this.field=r,this.code=e}}class d extends Error{constructor(e,t){super(e),this.name="NotificationStorageError",this.type=c.STORAGE_ERROR,this.operation=t}}class u extends Error{constructor(e,t){super(e),this.name="NotificationRateLimitError",this.type=c.RATE_LIMIT_EXCEEDED,this.waitTimeMinutes=t}}class f extends Error{constructor(e,t,r=!0){super(e),this.name="NotificationWhatsAppError",this.type=c.WHATSAPP_API_UNAVAILABLE,this.apiError=t,this.retryable=r}}class m{handleError(e,t){let r=t||"general",a=this.errorCounts.get(r)||0;return(this.errorCounts.set(r,a+1),this.lastErrors.set(r,new Date),e instanceof h)?{type:e.type,message:e.message,shouldRetry:!1}:e instanceof u?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:e.waitTimeMinutes}:e instanceof f?{type:e.type,message:e.message,shouldRetry:e.retryable,retryAfterMinutes:e.retryable?5:void 0}:e instanceof d?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:1}:e.message.includes("localStorage")?{type:c.STORAGE_ERROR,message:"Storage is not available or full",shouldRetry:!1}:e.message.includes("network")||e.message.includes("fetch")?{type:c.WHATSAPP_API_UNAVAILABLE,message:"Network error occurred",shouldRetry:!0,retryAfterMinutes:2}:{type:c.VALIDATION_ERROR,message:e.message||"Unknown error occurred",shouldRetry:!1}}getErrorStats(){let e=Array.from(this.errorCounts.values()).reduce((e,t)=>e+t,0),t={},r={};return this.errorCounts.forEach((e,r)=>{t[r]=e}),this.lastErrors.forEach((e,t)=>{r[t]=e}),{totalErrors:e,errorsByContext:t,recentErrors:r}}clearErrorStats(){this.errorCounts.clear(),this.lastErrors.clear()}hasTooManyErrors(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:60,a=this.errorCounts.get(e)||0,i=this.lastErrors.get(e);return!!i&&!(a<t)&&(Date.now()-i.getTime())/6e4<r}constructor(){this.errorCounts=new Map,this.lastErrors=new Map}}class N{static validatePhoneNumber(e){if(!e||"string"!=typeof e)throw new h(c.INVALID_PHONE_NUMBER,"Phone number is required","phoneNumber");let t=e.replace(/[\s\-\(\)]/g,""),r=t.startsWith("+")?t.substring(1):t;if(!/^\d+$/.test(r))throw new h(c.INVALID_PHONE_NUMBER,"Phone number can only contain digits after country code","phoneNumber");if(r.length<10||r.length>15)throw new h(c.INVALID_PHONE_NUMBER,"Phone number must be 10-15 digits including country code","phoneNumber");if(["000","111","222","333","444","555","666","777","888","999"].includes(r.substring(0,3)))throw new h(c.INVALID_PHONE_NUMBER,"Invalid country code","phoneNumber")}static validateThresholdPercentage(e){if(null==e)throw new h(c.VALIDATION_ERROR,"Threshold percentage is required","thresholdPercentage");if("number"!=typeof e||isNaN(e))throw new h(c.VALIDATION_ERROR,"Threshold must be a valid number","thresholdPercentage");if(e<1)throw new h(c.VALIDATION_ERROR,"Threshold must be at least 1%","thresholdPercentage");if(e>200)throw new h(c.VALIDATION_ERROR,"Threshold cannot exceed 200%","thresholdPercentage");if((e.toString().split(".")[1]||"").length>1)throw new h(c.VALIDATION_ERROR,"Threshold can have at most 1 decimal place","thresholdPercentage")}static validateSimulatorId(e){if(!e||"string"!=typeof e)throw new h(c.VALIDATION_ERROR,"Simulator ID is required","simulatorId");if(0===e.trim().length)throw new h(c.VALIDATION_ERROR,"Simulator ID cannot be empty","simulatorId");if(e.length>100)throw new h(c.VALIDATION_ERROR,"Simulator ID is too long (max 100 characters)","simulatorId");if(!/^[a-zA-Z0-9\-_]+$/.test(e))throw new h(c.VALIDATION_ERROR,"Simulator ID can only contain letters, numbers, hyphens, and underscores","simulatorId")}static validateNotificationSettings(e){if("object"!=typeof e||null===e)throw new h(c.VALIDATION_ERROR,"Settings must be an object","settings");if(void 0!==e.cooldownMinutes){if("number"!=typeof e.cooldownMinutes||isNaN(e.cooldownMinutes))throw new h(c.VALIDATION_ERROR,"Cooldown minutes must be a number","cooldownMinutes");if(e.cooldownMinutes<1||e.cooldownMinutes>1440)throw new h(c.VALIDATION_ERROR,"Cooldown minutes must be between 1 and 1440 (24 hours)","cooldownMinutes")}if(void 0!==e.maxDailyNotifications){if("number"!=typeof e.maxDailyNotifications||isNaN(e.maxDailyNotifications))throw new h(c.VALIDATION_ERROR,"Max daily notifications must be a number","maxDailyNotifications");if(e.maxDailyNotifications<1||e.maxDailyNotifications>100)throw new h(c.VALIDATION_ERROR,"Max daily notifications must be between 1 and 100","maxDailyNotifications")}if(void 0!==e.enabledGlobally&&"boolean"!=typeof e.enabledGlobally)throw new h(c.VALIDATION_ERROR,"Enabled globally must be a boolean","enabledGlobally")}static validateTriggerData(e){if("object"!=typeof e||null===e)throw new h(c.VALIDATION_ERROR,"Trigger data must be an object");if(this.validateSimulatorId(e.simulatorId),this.validatePhoneNumber(e.phoneNumber),this.validateThresholdPercentage(e.thresholdPercentage),void 0!==e.isActive&&"boolean"!=typeof e.isActive)throw new h(c.VALIDATION_ERROR,"isActive must be a boolean","isActive")}}class y{static handleWhatsAppError(e,t){let r="WhatsApp API error occurred",a=!0,i="";if(e&&"object"==typeof e&&(e.message&&(i=e.message,r="WhatsApp API error: ".concat(e.message)),e.code))switch(e.code){case"PHONE_NOT_WHATSAPP":r="Phone number ".concat(t," is not registered with WhatsApp"),a=!1;break;case"RATE_LIMIT":r="WhatsApp API rate limit exceeded",a=!0;break;case"INVALID_PHONE":r="Invalid phone number format: ".concat(t),a=!1;break;case"API_UNAVAILABLE":r="WhatsApp API is temporarily unavailable",a=!0;break;case"AUTHENTICATION_FAILED":r="WhatsApp API authentication failed",a=!1;break;default:r="WhatsApp API error (".concat(e.code,"): ").concat(e.message||"Unknown error")}return new f(r,i,a)}static isRetryableError(e){return e instanceof f?e.retryable:!!(e.message.includes("network")||e.message.includes("timeout")||e.message.includes("fetch"))}static getRetryDelay(e,t){return e instanceof u?Math.min(6e4*e.waitTimeMinutes,3e5):Math.min(1e3*Math.pow(2,t-1),3e5)}}let w=new m;class p{async createTrigger(e){try{if(N.validateTriggerData(e),(await this.storage.getTriggersBySimulator(e.simulatorId)).find(t=>t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage))throw new h(c.DUPLICATE_TRIGGER,"A trigger with the same phone number and threshold already exists for this simulator");let t=function(e){let t=new Date().toISOString();return{id:"trigger-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),createdAt:t,updatedAt:t,...e}}(e);return await this.storage.saveTrigger(t),t}catch(e){throw w.handleError(e,"createTrigger"),e}}async updateTrigger(e,t){let r=await this.storage.getTrigger(e);if(!r)throw Error("Trigger with id ".concat(e," not found"));if(t.phoneNumber||t.thresholdPercentage||t.simulatorId){let a={phoneNumber:t.phoneNumber||r.phoneNumber,thresholdPercentage:t.thresholdPercentage||r.thresholdPercentage,simulatorId:t.simulatorId||r.simulatorId},i=(0,l.X_)(a);if(!i.isValid)throw Error("Validation failed: ".concat(i.errors.join(", ")));if((await this.storage.getTriggersBySimulator(a.simulatorId)).find(t=>t.id!==e&&t.phoneNumber===a.phoneNumber&&t.thresholdPercentage===a.thresholdPercentage))throw Error("A trigger with the same phone number and threshold already exists for this simulator")}await this.storage.updateTrigger(e,t);let a=await this.storage.getTrigger(e);if(!a)throw Error("Failed to retrieve updated trigger");return a}async deleteTrigger(e){if(!await this.storage.getTrigger(e))throw Error("Trigger with id ".concat(e," not found"));await this.storage.deleteTrigger(e)}async getTrigger(e){return await this.storage.getTrigger(e)}async getTriggersBySimulator(e){return await this.storage.getTriggersBySimulator(e)}async getAllTriggers(){return await this.storage.getAllTriggers()}async getActiveTriggersBySimulator(e){return(await this.storage.getTriggersBySimulator(e)).filter(e=>e.isActive)}async checkThresholds(e,t){try{console.log("[NotificationManager] Checking thresholds for ".concat(e," at ").concat(t,"%"));let r=await this.storage.getSettings();if(console.log("[NotificationManager] Settings:",r),!r.enabledGlobally){console.log("[NotificationManager] Notifications globally disabled");return}let a=await this.getActiveTriggersBySimulator(e);for(let e of(console.log("[NotificationManager] Found ".concat(a.length," active triggers:"),a),a))console.log("[NotificationManager] Checking trigger ".concat(e.id,": ").concat(t,"% >= ").concat(e.thresholdPercentage,"%")),t>=e.thresholdPercentage&&(console.log("[NotificationManager] Threshold exceeded! Processing trigger ".concat(e.id)),await this.processTrigger(e,t,r))}catch(e){console.error("Error checking thresholds:",e)}}async processTrigger(e,t,r){try{console.log("[NotificationManager] Processing trigger ".concat(e.id," for ").concat(e.phoneNumber));let a=await this.storage.getLastNotificationTime(e.id);if(a){let e=(Date.now()-a.getTime())/6e4;if(console.log("[NotificationManager] Minutes since last notification: ".concat(e,", cooldown: ").concat(r.cooldownMinutes)),e<r.cooldownMinutes){console.log("[NotificationManager] Still in cooldown period, skipping");return}}let i=new Date;i.setHours(0,0,0,0);let o=await this.getTodayNotificationHistory(e.id,i);if(console.log("[NotificationManager] Today's notifications: ".concat(o.length,", limit: ").concat(r.maxDailyNotifications)),o.length>=r.maxDailyNotifications){console.log("[NotificationManager] Daily limit reached, skipping");return}console.log("[NotificationManager] Sending notification to ".concat(e.phoneNumber));let n=await this.sendNotification(e,t),c=s(e,t,n,n?void 0:"Failed to send WhatsApp message");await this.storage.saveNotificationHistory(c),n&&await this.storage.setLastNotificationTime(e.id,new Date)}catch(a){console.error("Error processing trigger:",a);let r=s(e,t,!1,a instanceof Error?a.message:"Unknown error");await this.storage.saveNotificationHistory(r)}}async sendNotification(e,t){try{if(!(await (0,g.n_)()).ready)throw y.handleWhatsAppError({code:"API_UNAVAILABLE",message:"WhatsApp API is not ready"},e.phoneNumber);let r=this.createNotificationMessage(e.simulatorId,t,e.thresholdPercentage),a=await (0,g.U3)({to:e.phoneNumber,message:r});if(!a.success)throw y.handleWhatsAppError({message:a.error||"Failed to send WhatsApp message"},e.phoneNumber);return!0}catch(e){return console.error("Failed to send notification:",w.handleError(e,"sendNotification").message),!1}}createNotificationMessage(e,t,r){let a=new Date().toLocaleString();return"\uD83D\uDEA8 EMS Alert: Energy Usage Threshold Exceeded\n\nSimulator: ".concat(e,"\nCurrent Usage: ").concat(t.toFixed(1),"% of target\nThreshold: ").concat(r,"%\n\nTime: ").concat(a,"\n\nPlease check your energy consumption and take appropriate action.")}async getNotificationHistory(e,t){return await this.storage.getNotificationHistory(e,t)}async getAllNotificationHistory(e){return await this.storage.getAllNotificationHistory(e)}async getTodayNotificationHistory(e,t){let r=await this.storage.getAllNotificationHistory(1e3),a=new Date(t);return a.setDate(a.getDate()+1),r.filter(r=>{let i=new Date(r.sentAt);return r.triggerId===e&&i>=t&&i<a})}async getSettings(){return await this.storage.getSettings()}async updateSettings(e){try{return N.validateNotificationSettings(e),await this.storage.updateSettings(e),await this.storage.getSettings()}catch(e){throw w.handleError(e,"updateSettings"),e}}async getSystemStatus(){try{let[e,t,r,a]=await Promise.all([(0,g.n_)(),this.getAllTriggers(),this.getSettings(),this.getAllNotificationHistory(50)]),i=t.filter(e=>e.isActive),o=new Date(Date.now()-864e5),s=a.filter(e=>new Date(e.sentAt)>o).length;return{whatsappReady:e.ready,totalTriggers:t.length,activeTriggers:i.length,notificationsEnabled:r.enabledGlobally,recentNotifications:s}}catch(e){return console.error("Error getting system status:",e),{whatsappReady:!1,totalTriggers:0,activeTriggers:0,notificationsEnabled:!1,recentNotifications:0}}}async toggleTrigger(e,t){return await this.updateTrigger(e,{isActive:t})}async bulkToggleTriggers(e,t){for(let r of(await this.getTriggersBySimulator(e)))await this.updateTrigger(r.id,{isActive:t})}async clearNotificationHistory(e){if(e)throw(await this.storage.getAllNotificationHistory(1e4)).filter(t=>t.simulatorId!==e),Error("Selective history clearing not yet implemented");await this.storage.clearAllData()}constructor(e){this.storage=e||new o}}let A=new p},18910:function(e,t,r){function a(e){if(!e||"string"!=typeof e)return{isValid:!1,error:"Phone number is required"};let t=e.replace(/[\s\-\(\)\+]/g,"");return/^\d+$/.test(t)?t.length<10||t.length>15?{isValid:!1,error:"Phone number must be 10-15 digits including country code"}:t.match(/^(\d{1,4})/)?{isValid:!0,formattedNumber:t}:{isValid:!1,error:"Invalid country code format"}:{isValid:!1,error:"Phone number can only contain digits"}}function i(e){if(null==e||""===e)return{isValid:!1,error:"Threshold percentage is required"};let t="string"==typeof e?parseFloat(e):e;return isNaN(t)?{isValid:!1,error:"Threshold must be a valid number"}:t<1?{isValid:!1,error:"Threshold must be at least 1%"}:t>200?{isValid:!1,error:"Threshold cannot exceed 200%"}:{isValid:!0,normalizedValue:Math.round(10*t)/10}}function o(e){let t=[],r=a(e.phoneNumber);r.isValid||t.push(r.error);let o=i(e.thresholdPercentage);return o.isValid||t.push(o.error),e.simulatorId&&"string"==typeof e.simulatorId&&0!==e.simulatorId.trim().length||t.push("Simulator ID is required"),{isValid:0===t.length,errors:t}}function s(e){let t=a(e);if(!t.isValid||!t.formattedNumber)return e;let r=t.formattedNumber;return r.length<=13?r.replace(/(\d{1,3})(\d{3})(\d{3})(\d+)/,"$1 $2 $3 $4"):r}r.d(t,{We:function(){return s},X_:function(){return o},Y0:function(){return a},c4:function(){return i}})},61233:function(e,t,r){async function a(e){try{let t=await fetch("/api/whatsapp/send",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({to:e.to,message:e.message})});if(!t.ok){let e=await t.json().catch(()=>({}));return{success:!1,error:e.error||"Failed to send message: ".concat(t.status," ").concat(t.statusText)}}let r=await t.json();return{success:r.success||!0,id:r.id,to:r.to,message:r.message||"Message sent successfully"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error occurred"}}}async function i(){try{let e=await fetch("/api/whatsapp/status",{method:"GET",headers:{Accept:"application/json"}}),t=await e.json();return{ready:!0===t.ready,hasQR:!0===t.hasQR}}catch(e){return{ready:!1,hasQR:!1}}}async function o(){try{let e=await fetch("/api/whatsapp/qr",{method:"GET",headers:{Accept:"application/json"}});return{qr:(await e.json()).qr||null}}catch(e){return{qr:null}}}r.d(t,{U3:function(){return a},n_:function(){return i},sE:function(){return o}})}}]);