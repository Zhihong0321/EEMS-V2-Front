"use strict";exports.id=916,exports.ids=[916],exports.modules={91664:(e,t,r)=>{r.d(t,{z:()=>n});var a=r(10326),i=r(17577),s=r(41135);let o={variant:{primary:"bg-primary text-white shadow-sm hover:bg-cyan-600 hover:shadow-md active:scale-95",secondary:"border border-slate-700 bg-transparent text-slate-200 hover:bg-slate-800 hover:border-slate-600",ghost:"hover:bg-slate-800/50 text-slate-300 hover:text-white",danger:"bg-danger text-white shadow-sm hover:bg-red-600 hover:shadow-md active:scale-95",success:"bg-success text-white shadow-sm hover:bg-green-600 hover:shadow-md active:scale-95"},size:{sm:"px-3 py-1.5 text-xs min-h-[36px]",md:"px-4 py-2 text-sm min-h-[44px]",lg:"px-6 py-3 text-base min-h-[48px]"}},n=(0,i.forwardRef)(({className:e,variant:t="primary",size:r="md",isLoading:i,children:n,disabled:l,...c},h)=>(0,a.jsxs)("button",{className:(0,s.Z)("inline-flex items-center justify-center gap-2 rounded-md font-semibold transition-all duration-150","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950","disabled:pointer-events-none disabled:opacity-50",o.variant[t],o.size[r],e),ref:h,disabled:l||i,...c,children:[i&&(0,a.jsxs)("svg",{className:"h-4 w-4 animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","aria-hidden":"true",children:[a.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),a.jsx("span",{className:i?"opacity-70":"",children:n})]}));n.displayName="Button"},4753:(e,t,r)=>{r.d(t,{Dr:()=>n,HM:()=>g,Oz:()=>h,Qu:()=>u,tQ:()=>f,w:()=>d,wC:()=>c,wE:()=>l});let a=[{name:"NEXT_PUBLIC_BACKEND_TOKEN",value:"01121000099"},{name:"NEXT_PUBLIC_BACKEND_WRITE_TOKEN",value:process.env.NEXT_PUBLIC_BACKEND_WRITE_TOKEN},{name:"NEXT_PUBLIC_BACKEND_KEY",value:process.env.NEXT_PUBLIC_BACKEND_KEY},{name:"NEXT_PUBLIC_BACKEND_API_KEY",value:process.env.NEXT_PUBLIC_BACKEND_API_KEY}],i=null,s=!1;function o(){for(let e of a)if(e.value)return{name:e.name,value:e.value};return null}function n(){return o()?.value??""}function l(){return o()?.name??null}function c(){return s&&!!i}function h(e,t){i=e.trim()||null,s=!!(t?.persist&&i)}function g(){i=null,s=!1}function d(){return i||n()}function u(){return d().length>0}function f(){return n().length>0}},18069:(e,t,r)=>{r.d(t,{Aq:()=>T,Bj:()=>f,CT:()=>i,LK:()=>u,M8:()=>E,Mf:()=>m,QY:()=>N,aj:()=>w,b0:()=>d,he:()=>A,ji:()=>y,lA:()=>p});var a=r(4753);let i="/api/bridge",s=new Set([429,500,502,503,504]);class o extends Error{constructor(e,t,r,a){super(e),this.status=t,this.code=r,this.details=a}}function n(e){if(!i)throw new o("Backend base URL is not configured.",0);return e.startsWith("http")?e:`${i}${e}`}async function l(e){let t=await e.text();if(t)try{return JSON.parse(t)}catch(t){throw new o(`Invalid JSON response: ${t.message}`,e.status)}}async function c(e){let t;try{t=await e.clone().json()}catch{}if(!t)try{let t=await e.text();if(t)return new o(t,e.status)}catch{}let r=t?.error?.message??t?.message??e.statusText??`Request failed with status ${e.status}`,a=t?.error?.code,i=t?.error?.details;if(t&&t.detail){i=t.detail;try{if(Array.isArray(t.detail)){let e=t.detail.map(e=>e?.msg||e?.detail||"Validation error").filter(Boolean);e.length>0&&(r=e.join("; "))}else"string"==typeof t.detail&&(r=t.detail)}catch{}}return new o(r,e.status,a,i)}function h(e){return new Promise(t=>setTimeout(t,e))}async function g(e,t,r={}){let a=n(e);a=`http://localhost${a}`;let i=r.retryDelays??[],g=0,d=new Headers(t?.headers);d.set("Accept","application/json");let u={...t,headers:d};for(;;)try{let e=await fetch(a,u);if(!e.ok){var f;let t=await c(e);if(f=e.status,s.has(f)&&g<i.length){await h(i[g++]);continue}throw t}if(204===e.status)return;return await l(e)}catch(e){if(e instanceof o)throw e;if(g<i.length){await h(i[g++]);continue}throw e}}function d(e){let t=new Headers(e?.headers);t.set("Content-Type","application/json");let r=(0,a.w)();return r?t.set("x-api-key",r):t.delete("x-api-key"),{...e,headers:t}}async function u(e,t){try{return await g(e,t)}catch(r){if(!(r instanceof o))return await g(e,t,{retryDelays:[500]});throw r}}function f(e){return n(e)}async function m(){let e=await u("/api/v1/simulators");return Array.isArray(e)?e:e.data??[]}async function y(e){let t=await g("/api/v1/simulators",d({method:"POST",body:JSON.stringify(e)}),{retryDelays:[500,1500,3500]});return"data"in t?t.data:t}async function w(e){console.log("deleteSimulator called with id:",e);try{await g(`/api/v1/simulators/${e}`,d({method:"DELETE"}),{retryDelays:[500,1500]}),console.log("deleteSimulator successful for id:",e)}catch(t){throw console.error("deleteSimulator error for id:",e,t),t}}async function p(e){return await u(`/api/v1/blocks/latest?simulator_id=${encodeURIComponent(e)}`)}async function N(e,t=10){let r=await u(`/api/v1/blocks/history?simulator_id=${encodeURIComponent(e)}&limit=${t}`);return Array.isArray(r)?r:r.data??[]}async function E(e){await g("/api/v1/readings:ingest",d({method:"POST",body:JSON.stringify(e)}),{retryDelays:[500,1500,3500]})}async function T(e){try{let t=new Date().toISOString();await g(`/api/v1/readings?simulator_id=${encodeURIComponent(e)}&before=${encodeURIComponent(t)}`,d({method:"DELETE"}),{retryDelays:[500,1500]})}catch(t){try{await g(`/api/v1/simulators/${encodeURIComponent(e)}/readings`,d({method:"DELETE"}),{retryDelays:[500,1500]})}catch(e){console.warn("Failed to delete future readings from backend:",t,e)}}}async function A(e){try{let t=await p(e);if(t.chart_bins?.points&&t.chart_bins.points.length>0){let e=new Date(t.block_start_local),r=t.chart_bins.bin_seconds||30,a=t.chart_bins.points.length;return new Date(e.getTime()+a*r*1e3).toISOString()}return null}catch(e){return console.warn("Failed to fetch last reading timestamp:",e),null}}},13798:(e,t,r)=>{r.d(t,{O:()=>N}),function(e){e.WHATSAPP_API_UNAVAILABLE="WHATSAPP_API_UNAVAILABLE",e.INVALID_PHONE_NUMBER="INVALID_PHONE_NUMBER",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.STORAGE_ERROR="STORAGE_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR",e.DUPLICATE_TRIGGER="DUPLICATE_TRIGGER",e.COOLDOWN_ACTIVE="COOLDOWN_ACTIVE"}(n||(n={}));let a={TRIGGERS:"notification_triggers",HISTORY:"notification_history",SETTINGS:"notification_settings",COOLDOWNS:"notification_cooldowns"},i={cooldownMinutes:15,maxDailyNotifications:10,enabledGlobally:!0};class s{safeParseJSON(e,t){try{let r=localStorage.getItem(e);if(null===r)return t;return JSON.parse(r)}catch(r){return console.error(`Error parsing localStorage item ${e}:`,r),t}}safeSaveJSON(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(t){throw console.error(`Error saving to localStorage ${e}:`,t),Error(`Storage error: ${t instanceof Error?t.message:"Unknown error"}`)}}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async saveTrigger(e){let t=this.safeParseJSON(a.TRIGGERS,[]);if(t.find(t=>t.simulatorId===e.simulatorId&&t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage&&t.id!==e.id))throw Error("A trigger with the same simulator, phone number, and threshold already exists");let r=t.findIndex(t=>t.id===e.id);r>=0?t[r]=e:t.push(e),this.safeSaveJSON(a.TRIGGERS,t)}async getTrigger(e){return this.safeParseJSON(a.TRIGGERS,[]).find(t=>t.id===e)||null}async getTriggersBySimulator(e){return this.safeParseJSON(a.TRIGGERS,[]).filter(t=>t.simulatorId===e)}async getAllTriggers(){return this.safeParseJSON(a.TRIGGERS,[])}async updateTrigger(e,t){let r=this.safeParseJSON(a.TRIGGERS,[]),i=r.findIndex(t=>t.id===e);if(-1===i)throw Error(`Trigger with id ${e} not found`);r[i]={...r[i],...t,updatedAt:new Date().toISOString()},this.safeSaveJSON(a.TRIGGERS,r)}async deleteTrigger(e){let t=this.safeParseJSON(a.TRIGGERS,[]),r=t.filter(t=>t.id!==e);if(t.length===r.length)throw Error(`Trigger with id ${e} not found`);this.safeSaveJSON(a.TRIGGERS,r);let i=this.safeParseJSON(a.COOLDOWNS,{});delete i[e],this.safeSaveJSON(a.COOLDOWNS,i)}async saveNotificationHistory(e){let t=this.safeParseJSON(a.HISTORY,[]);t.push(e),t.length>1e3&&t.splice(0,t.length-1e3),this.safeSaveJSON(a.HISTORY,t)}async getNotificationHistory(e,t=100){return this.safeParseJSON(a.HISTORY,[]).filter(t=>t.simulatorId===e).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,t)}async getAllNotificationHistory(e=100){return this.safeParseJSON(a.HISTORY,[]).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,e)}async getSettings(){return this.safeParseJSON(a.SETTINGS,i)}async updateSettings(e){let t={...await this.getSettings(),...e};this.safeSaveJSON(a.SETTINGS,t)}async getLastNotificationTime(e){let t=this.safeParseJSON(a.COOLDOWNS,{})[e];return t?new Date(t):null}async setLastNotificationTime(e,t){let r=this.safeParseJSON(a.COOLDOWNS,{});r[e]=t.toISOString(),this.safeSaveJSON(a.COOLDOWNS,r)}async clearAllData(){Object.values(a).forEach(e=>{localStorage.removeItem(e)})}async exportData(){return JSON.stringify({triggers:this.safeParseJSON(a.TRIGGERS,[]),history:this.safeParseJSON(a.HISTORY,[]),settings:this.safeParseJSON(a.SETTINGS,i),cooldowns:this.safeParseJSON(a.COOLDOWNS,{}),exportedAt:new Date().toISOString()},null,2)}async importData(e){try{let t=JSON.parse(e);t.triggers&&this.safeSaveJSON(a.TRIGGERS,t.triggers),t.history&&this.safeSaveJSON(a.HISTORY,t.history),t.settings&&this.safeSaveJSON(a.SETTINGS,t.settings),t.cooldowns&&this.safeSaveJSON(a.COOLDOWNS,t.cooldowns)}catch(e){throw Error(`Invalid import data: ${e instanceof Error?e.message:"Unknown error"}`)}}}function o(e,t,r,a){return{id:`history-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,triggerId:e.id,simulatorId:e.simulatorId,phoneNumber:e.phoneNumber,thresholdPercentage:e.thresholdPercentage,actualPercentage:t,sentAt:new Date().toISOString(),success:r,errorMessage:a}}new s;var n,l=r(52041),c=r(94337);class h extends Error{constructor(e,t,r){super(t),this.name="NotificationValidationError",this.type=e,this.field=r,this.code=e}}class g extends Error{constructor(e,t){super(e),this.name="NotificationStorageError",this.type=n.STORAGE_ERROR,this.operation=t}}class d extends Error{constructor(e,t){super(e),this.name="NotificationRateLimitError",this.type=n.RATE_LIMIT_EXCEEDED,this.waitTimeMinutes=t}}class u extends Error{constructor(e,t,r=!0){super(e),this.name="NotificationWhatsAppError",this.type=n.WHATSAPP_API_UNAVAILABLE,this.apiError=t,this.retryable=r}}class f{handleError(e,t){let r=t||"general",a=this.errorCounts.get(r)||0;return(this.errorCounts.set(r,a+1),this.lastErrors.set(r,new Date),e instanceof h)?{type:e.type,message:e.message,shouldRetry:!1}:e instanceof d?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:e.waitTimeMinutes}:e instanceof u?{type:e.type,message:e.message,shouldRetry:e.retryable,retryAfterMinutes:e.retryable?5:void 0}:e instanceof g?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:1}:e.message.includes("localStorage")?{type:n.STORAGE_ERROR,message:"Storage is not available or full",shouldRetry:!1}:e.message.includes("network")||e.message.includes("fetch")?{type:n.WHATSAPP_API_UNAVAILABLE,message:"Network error occurred",shouldRetry:!0,retryAfterMinutes:2}:{type:n.VALIDATION_ERROR,message:e.message||"Unknown error occurred",shouldRetry:!1}}getErrorStats(){let e=Array.from(this.errorCounts.values()).reduce((e,t)=>e+t,0),t={},r={};return this.errorCounts.forEach((e,r)=>{t[r]=e}),this.lastErrors.forEach((e,t)=>{r[t]=e}),{totalErrors:e,errorsByContext:t,recentErrors:r}}clearErrorStats(){this.errorCounts.clear(),this.lastErrors.clear()}hasTooManyErrors(e,t=10,r=60){let a=this.errorCounts.get(e)||0,i=this.lastErrors.get(e);return!!i&&!(a<t)&&(Date.now()-i.getTime())/6e4<r}constructor(){this.errorCounts=new Map,this.lastErrors=new Map}}class m{static validatePhoneNumber(e){if(!e||"string"!=typeof e)throw new h(n.INVALID_PHONE_NUMBER,"Phone number is required","phoneNumber");let t=e.replace(/[\s\-\(\)]/g,""),r=t.startsWith("+")?t.substring(1):t;if(!/^\d+$/.test(r))throw new h(n.INVALID_PHONE_NUMBER,"Phone number can only contain digits after country code","phoneNumber");if(r.length<10||r.length>15)throw new h(n.INVALID_PHONE_NUMBER,"Phone number must be 10-15 digits including country code","phoneNumber");if(["000","111","222","333","444","555","666","777","888","999"].includes(r.substring(0,3)))throw new h(n.INVALID_PHONE_NUMBER,"Invalid country code","phoneNumber")}static validateThresholdPercentage(e){if(null==e)throw new h(n.VALIDATION_ERROR,"Threshold percentage is required","thresholdPercentage");if("number"!=typeof e||isNaN(e))throw new h(n.VALIDATION_ERROR,"Threshold must be a valid number","thresholdPercentage");if(e<1)throw new h(n.VALIDATION_ERROR,"Threshold must be at least 1%","thresholdPercentage");if(e>200)throw new h(n.VALIDATION_ERROR,"Threshold cannot exceed 200%","thresholdPercentage");if((e.toString().split(".")[1]||"").length>1)throw new h(n.VALIDATION_ERROR,"Threshold can have at most 1 decimal place","thresholdPercentage")}static validateSimulatorId(e){if(!e||"string"!=typeof e)throw new h(n.VALIDATION_ERROR,"Simulator ID is required","simulatorId");if(0===e.trim().length)throw new h(n.VALIDATION_ERROR,"Simulator ID cannot be empty","simulatorId");if(e.length>100)throw new h(n.VALIDATION_ERROR,"Simulator ID is too long (max 100 characters)","simulatorId");if(!/^[a-zA-Z0-9\-_]+$/.test(e))throw new h(n.VALIDATION_ERROR,"Simulator ID can only contain letters, numbers, hyphens, and underscores","simulatorId")}static validateNotificationSettings(e){if("object"!=typeof e||null===e)throw new h(n.VALIDATION_ERROR,"Settings must be an object","settings");if(void 0!==e.cooldownMinutes){if("number"!=typeof e.cooldownMinutes||isNaN(e.cooldownMinutes))throw new h(n.VALIDATION_ERROR,"Cooldown minutes must be a number","cooldownMinutes");if(e.cooldownMinutes<1||e.cooldownMinutes>1440)throw new h(n.VALIDATION_ERROR,"Cooldown minutes must be between 1 and 1440 (24 hours)","cooldownMinutes")}if(void 0!==e.maxDailyNotifications){if("number"!=typeof e.maxDailyNotifications||isNaN(e.maxDailyNotifications))throw new h(n.VALIDATION_ERROR,"Max daily notifications must be a number","maxDailyNotifications");if(e.maxDailyNotifications<1||e.maxDailyNotifications>100)throw new h(n.VALIDATION_ERROR,"Max daily notifications must be between 1 and 100","maxDailyNotifications")}if(void 0!==e.enabledGlobally&&"boolean"!=typeof e.enabledGlobally)throw new h(n.VALIDATION_ERROR,"Enabled globally must be a boolean","enabledGlobally")}static validateTriggerData(e){if("object"!=typeof e||null===e)throw new h(n.VALIDATION_ERROR,"Trigger data must be an object");if(this.validateSimulatorId(e.simulatorId),this.validatePhoneNumber(e.phoneNumber),this.validateThresholdPercentage(e.thresholdPercentage),void 0!==e.isActive&&"boolean"!=typeof e.isActive)throw new h(n.VALIDATION_ERROR,"isActive must be a boolean","isActive")}}class y{static handleWhatsAppError(e,t){let r="WhatsApp API error occurred",a=!0,i="";if(e&&"object"==typeof e&&(e.message&&(i=e.message,r=`WhatsApp API error: ${e.message}`),e.code))switch(e.code){case"PHONE_NOT_WHATSAPP":r=`Phone number ${t} is not registered with WhatsApp`,a=!1;break;case"RATE_LIMIT":r="WhatsApp API rate limit exceeded",a=!0;break;case"INVALID_PHONE":r=`Invalid phone number format: ${t}`,a=!1;break;case"API_UNAVAILABLE":r="WhatsApp API is temporarily unavailable",a=!0;break;case"AUTHENTICATION_FAILED":r="WhatsApp API authentication failed",a=!1;break;default:r=`WhatsApp API error (${e.code}): ${e.message||"Unknown error"}`}return new u(r,i,a)}static isRetryableError(e){return e instanceof u?e.retryable:!!(e.message.includes("network")||e.message.includes("timeout")||e.message.includes("fetch"))}static getRetryDelay(e,t){return e instanceof d?Math.min(6e4*e.waitTimeMinutes,3e5):Math.min(1e3*Math.pow(2,t-1),3e5)}}let w=new f;class p{constructor(e){this.storage=e||new s}async createTrigger(e){try{if(m.validateTriggerData(e),(await this.storage.getTriggersBySimulator(e.simulatorId)).find(t=>t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage))throw new h(n.DUPLICATE_TRIGGER,"A trigger with the same phone number and threshold already exists for this simulator");let t=function(e){let t=new Date().toISOString();return{id:`trigger-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:t,updatedAt:t,...e}}(e);return await this.storage.saveTrigger(t),t}catch(e){throw w.handleError(e,"createTrigger"),e}}async updateTrigger(e,t){let r=await this.storage.getTrigger(e);if(!r)throw Error(`Trigger with id ${e} not found`);if(t.phoneNumber||t.thresholdPercentage||t.simulatorId){let a={phoneNumber:t.phoneNumber||r.phoneNumber,thresholdPercentage:t.thresholdPercentage||r.thresholdPercentage,simulatorId:t.simulatorId||r.simulatorId},i=(0,l.X_)(a);if(!i.isValid)throw Error(`Validation failed: ${i.errors.join(", ")}`);if((await this.storage.getTriggersBySimulator(a.simulatorId)).find(t=>t.id!==e&&t.phoneNumber===a.phoneNumber&&t.thresholdPercentage===a.thresholdPercentage))throw Error("A trigger with the same phone number and threshold already exists for this simulator")}await this.storage.updateTrigger(e,t);let a=await this.storage.getTrigger(e);if(!a)throw Error("Failed to retrieve updated trigger");return a}async deleteTrigger(e){if(!await this.storage.getTrigger(e))throw Error(`Trigger with id ${e} not found`);await this.storage.deleteTrigger(e)}async getTrigger(e){return await this.storage.getTrigger(e)}async getTriggersBySimulator(e){return await this.storage.getTriggersBySimulator(e)}async getAllTriggers(){return await this.storage.getAllTriggers()}async getActiveTriggersBySimulator(e){return(await this.storage.getTriggersBySimulator(e)).filter(e=>e.isActive)}async checkThresholds(e,t){try{console.log(`[NotificationManager] Checking thresholds for ${e} at ${t}%`);let r=await this.storage.getSettings();if(console.log("[NotificationManager] Settings:",r),!r.enabledGlobally){console.log("[NotificationManager] Notifications globally disabled");return}let a=await this.getActiveTriggersBySimulator(e);for(let e of(console.log(`[NotificationManager] Found ${a.length} active triggers:`,a),a))console.log(`[NotificationManager] Checking trigger ${e.id}: ${t}% >= ${e.thresholdPercentage}%`),t>=e.thresholdPercentage&&(console.log(`[NotificationManager] Threshold exceeded! Processing trigger ${e.id}`),await this.processTrigger(e,t,r))}catch(e){console.error("Error checking thresholds:",e)}}async processTrigger(e,t,r){try{let a;console.log(`[NotificationManager] Processing trigger ${e.id} for ${e.phoneNumber}`);let i=await this.storage.getLastNotificationTime(e.id);if(i){let e=(Date.now()-i.getTime())/6e4;if(console.log(`[NotificationManager] Minutes since last notification: ${e}, cooldown: ${r.cooldownMinutes}`),e<r.cooldownMinutes){console.log("[NotificationManager] Still in cooldown period, skipping");return}}let s=new Date;s.setHours(0,0,0,0);let n=await this.getTodayNotificationHistory(e.id,s);if(console.log(`[NotificationManager] Today's notifications: ${n.length}, limit: ${r.maxDailyNotifications}`),n.length>=r.maxDailyNotifications){console.log("[NotificationManager] Daily limit reached, skipping");return}console.log(`[NotificationManager] Sending notification to ${e.phoneNumber}`);let l=!1;try{l=await this.sendNotification(e,t)}catch(e){l=!1,a=e.detailedMessage||(e instanceof Error?e.message:"Unknown error"),console.log(`[NotificationManager] Notification failed: ${a}`)}let c=o(e,t,l,l?void 0:a||"Failed to send WhatsApp message");console.log(`[NotificationManager] Recording history: ${l?"SUCCESS":"FAILED"} - ${e.phoneNumber}`),await this.storage.saveNotificationHistory(c),l&&await this.storage.setLastNotificationTime(e.id,new Date)}catch(i){console.error("Error processing trigger:",i);let r=i instanceof Error?i.message:"Unknown error",a=o(e,t,!1,`Processing error: ${r}`);console.log(`[NotificationManager] Recording FAILED attempt: ${r}`),await this.storage.saveNotificationHistory(a)}}async sendNotification(e,t){try{if(!(await (0,c.n_)()).ready)throw y.handleWhatsAppError({code:"API_UNAVAILABLE",message:"WhatsApp API is not ready"},e.phoneNumber);let r=this.createNotificationMessage(e.simulatorId,t,e.thresholdPercentage),a=await (0,c.U3)({to:e.phoneNumber,message:r});if(!a.success)throw y.handleWhatsAppError({message:a.error||"Failed to send WhatsApp message"},e.phoneNumber);return!0}catch(r){let t=w.handleError(r,"sendNotification");throw console.error(`[NotificationManager] Failed to send notification to ${e.phoneNumber}:`,t.message),r.detailedMessage=t.message,r}}createNotificationMessage(e,t,r){let a=new Date().toLocaleString();return`ðŸš¨ EMS Alert: Energy Usage Threshold Exceeded

Simulator: ${e}
Current Usage: ${t.toFixed(1)}% of target
Threshold: ${r}%

Time: ${a}

Please check your energy consumption and take appropriate action.`}async getNotificationHistory(e,t){return await this.storage.getNotificationHistory(e,t)}async getAllNotificationHistory(e){return await this.storage.getAllNotificationHistory(e)}async getTodayNotificationHistory(e,t){let r=await this.storage.getAllNotificationHistory(1e3),a=new Date(t);return a.setDate(a.getDate()+1),r.filter(r=>{let i=new Date(r.sentAt);return r.triggerId===e&&i>=t&&i<a})}async getSettings(){return await this.storage.getSettings()}async updateSettings(e){try{return m.validateNotificationSettings(e),await this.storage.updateSettings(e),await this.storage.getSettings()}catch(e){throw w.handleError(e,"updateSettings"),e}}async getSystemStatus(){try{let[e,t,r,a]=await Promise.all([(0,c.n_)(),this.getAllTriggers(),this.getSettings(),this.getAllNotificationHistory(50)]),i=t.filter(e=>e.isActive),s=new Date(Date.now()-864e5),o=a.filter(e=>new Date(e.sentAt)>s).length;return{whatsappReady:e.ready,totalTriggers:t.length,activeTriggers:i.length,notificationsEnabled:r.enabledGlobally,recentNotifications:o}}catch(e){return console.error("Error getting system status:",e),{whatsappReady:!1,totalTriggers:0,activeTriggers:0,notificationsEnabled:!1,recentNotifications:0}}}async toggleTrigger(e,t){return await this.updateTrigger(e,{isActive:t})}async bulkToggleTriggers(e,t){for(let r of(await this.getTriggersBySimulator(e)))await this.updateTrigger(r.id,{isActive:t})}async clearNotificationHistory(e){if(e)throw(await this.storage.getAllNotificationHistory(1e4)).filter(t=>t.simulatorId!==e),Error("Selective history clearing not yet implemented");await this.storage.clearAllData()}}let N=new p},52041:(e,t,r)=>{function a(e){if(!e||"string"!=typeof e)return{isValid:!1,error:"Phone number is required"};let t=e.replace(/[\s\-\(\)\+]/g,"");return/^\d+$/.test(t)?t.length<10||t.length>15?{isValid:!1,error:"Phone number must be 10-15 digits including country code"}:t.match(/^(\d{1,4})/)?{isValid:!0,formattedNumber:t}:{isValid:!1,error:"Invalid country code format"}:{isValid:!1,error:"Phone number can only contain digits"}}function i(e){if(null==e||""===e)return{isValid:!1,error:"Threshold percentage is required"};let t="string"==typeof e?parseFloat(e):e;return isNaN(t)?{isValid:!1,error:"Threshold must be a valid number"}:t<1?{isValid:!1,error:"Threshold must be at least 1%"}:t>200?{isValid:!1,error:"Threshold cannot exceed 200%"}:{isValid:!0,normalizedValue:Math.round(10*t)/10}}function s(e){let t=[],r=a(e.phoneNumber);r.isValid||t.push(r.error);let s=i(e.thresholdPercentage);return s.isValid||t.push(s.error),e.simulatorId&&"string"==typeof e.simulatorId&&0!==e.simulatorId.trim().length||t.push("Simulator ID is required"),{isValid:0===t.length,errors:t}}function o(e){let t=a(e);if(!t.isValid||!t.formattedNumber)return e;let r=t.formattedNumber;return r.length<=13?r.replace(/(\d{1,3})(\d{3})(\d{3})(\d+)/,"$1 $2 $3 $4"):r}r.d(t,{We:()=>o,X_:()=>s,Y0:()=>a,c4:()=>i})},94337:(e,t,r)=>{async function a(e){try{let t=await fetch("/api/whatsapp/send",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({to:e.to,message:e.message})});if(!t.ok){let e=await t.json().catch(()=>({}));return{success:!1,error:e.error||`Failed to send message: ${t.status} ${t.statusText}`}}let r=await t.json();return{success:r.success||!0,id:r.id,to:r.to,message:r.message||"Message sent successfully"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error occurred"}}}async function i(){try{let e=await fetch("/api/whatsapp/status",{method:"GET",headers:{Accept:"application/json"}}),t=await e.json();return{ready:!0===t.ready,hasQR:!0===t.hasQR}}catch(e){return{ready:!1,hasQR:!1}}}async function s(){try{let e=await fetch("/api/whatsapp/qr",{method:"GET",headers:{Accept:"application/json"}});return{qr:(await e.json()).qr||null}}catch(e){return{qr:null}}}r.d(t,{U3:()=>a,n_:()=>i,sE:()=>s})}};