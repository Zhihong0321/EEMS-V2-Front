"use strict";exports.id=404,exports.ids=[404],exports.modules={458:(e,t,a)=>{a.d(t,{DashboardContent:()=>T});var s=a(326),r=a(7577),l=a(434),n=a(4958),i=a(669),o=a(4390),c=a(7445),d=a(4734),m=a(660),u=a(8423),x=a(2637),h=a(9997),g=a(4675);let p=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kuala_Lumpur"}),f=new Intl.NumberFormat(void 0,{maximumFractionDigits:2});function b({block:e,loading:t,targetKwh:a,mode:r}){let l=a??e?.target_kwh??0,b=(()=>{if(e){let t=new Date(e.block_start_local),a=new Date(t.getTime()+18e5);return{startTs:t.getTime(),endTs:a.getTime()}}let t=new Date,a=t.getMinutes(),s=new Date(t);s.setMinutes(30*Math.floor(a/30),0,0);let r=new Date(s.getTime()+18e5);return{startTs:s.getTime(),endTs:r.getTime()}})(),y=function(e,t){try{let a=new Date(e),s=new Date(t);return`${p.format(a)} – ${p.format(s)}`}catch{return"Invalid time range"}}(b.startTs,b.endTs),{data:j,startTs:N,endTs:k,binSeconds:v}=function(e,t,a){let{startTs:s,endTs:r}=a;if(!(e&&new Date(e.block_start_local).getTime()===s))return{data:Array(60).fill(null).map((e,t)=>({ts:s+(t+1)*3e4,value:0})),startTs:s,endTs:r,binSeconds:30};let l=e.chart_bins?.points??[],n=e.chart_bins?.bin_seconds??30,i=[];return i="accumulate"===t?l.map((e,t)=>({ts:s+(t+1)*n*1e3,value:e})):l.map((e,t)=>({ts:s+(t+1)*n*1e3,value:e-(0===t?0:l[t-1])})),{data:Array(Math.floor(1800/n)).fill(null).map((e,t)=>{let a=s+(t+1)*n*1e3;return i.find(e=>e.ts===a)??{ts:a,value:0}}),startTs:s,endTs:r,binSeconds:n}}(e,r,b),_="accumulate"===r,T=_?n.w:i.T,A=_?s.jsx(o.x,{type:"monotone",dataKey:"value",stroke:"#22d3ee",strokeWidth:2,dot:!1,isAnimationActive:!1}):s.jsx(c.u,{type:"monotone",dataKey:"value",stroke:"#22d3ee",fill:"#22d3ee",fillOpacity:.3,isAnimationActive:!1}),D=_?s.jsx(d.d,{y:l,stroke:"#f97316",strokeDasharray:"6 6"}):null;return(0,s.jsxs)("article",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,s.jsxs)("header",{className:"mb-6 flex flex-wrap items-end justify-between gap-4",children:[(0,s.jsxs)("div",{children:[s.jsx("h2",{className:"text-xl font-semibold text-white",children:"Current 30-minute block"}),(0,s.jsxs)("p",{className:"text-sm text-slate-400",children:["Window ",y]})]}),(0,s.jsxs)("div",{className:"rounded-md border border-slate-800 px-4 py-2 text-xs text-slate-400",children:["Target ",l.toFixed(1)," kWh \xb7 Accumulated ",e?.accumulated_kwh.toFixed(2)??"—"," kWh"]})]}),s.jsx("div",{className:"h-72 w-full",children:t?s.jsx("div",{className:"flex h-full items-center justify-center rounded-xl border border-dashed border-slate-800 bg-slate-950/40",children:s.jsx("span",{className:"text-sm text-slate-500",children:"Loading chart…"})}):0===j.length?s.jsx("div",{className:"flex h-full items-center justify-center rounded-xl border border-dashed border-slate-800 bg-slate-950/40",children:s.jsx("span",{className:"text-sm text-slate-500",children:"No readings for this block yet."})}):s.jsx(m.h,{width:"100%",height:"100%",children:(0,s.jsxs)(T,{data:j,margin:{left:12,right:12,top:12,bottom:12},children:[s.jsx(u.q,{strokeDasharray:"4 4",stroke:"#1f2937"}),s.jsx(x.K,{dataKey:"ts",type:"number",domain:[N,k],tickFormatter:e=>p.format(e),stroke:"#64748b",tickLine:!1}),s.jsx(h.B,{dataKey:"value",stroke:"#64748b",tickLine:!1,width:60,tickFormatter:e=>f.format(e)}),s.jsx(g.u,{content:s.jsx(w,{target:l,mode:r,binSeconds:v})}),D,A]})})}),s.jsx("p",{className:"mt-4 text-xs text-slate-500",children:"Streaming series updates replace the entire 60-point window whenever the backend publishes a block update."})]})}function w({active:e,payload:t,label:a,target:r,mode:l,binSeconds:n}){if(!e||!t||0===t.length||!a)return null;let i=t[0]?.value??0,o=r>0?(i/r*100).toFixed(1):"0",c="accumulate"===l?"Accumulated":`Usage per ${n}s`,d=p.format(a);return(0,s.jsxs)("div",{className:"rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-xs text-slate-200 shadow-lg",children:[(0,s.jsxs)("p",{className:"font-semibold",children:[d," \xb7 ",f.format(i)," kWh"]}),(0,s.jsxs)("p",{className:"text-slate-400",children:[c," \xb7 ",o,"% of target"]})]})}let y=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kuala_Lumpur"});function j({history:e,loading:t}){return(0,s.jsxs)("article",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-white",children:"History (last 10 blocks)"}),t?s.jsx("ul",{className:"mt-4 space-y-3",children:Array.from({length:4}).map((e,t)=>s.jsx("li",{className:"h-12 animate-pulse rounded-md bg-slate-800/40"},t))}):0===e.length?s.jsx("p",{className:"mt-4 text-sm text-slate-400",children:"No block history yet. Run the simulator to populate readings."}):s.jsx("ul",{className:"mt-4 space-y-3",children:e.map((e,t)=>{let a=e.percent_of_target,r="";try{let t=new Date(e.block_start_local),a=new Date(t.getTime()+18e5);r=`${y.format(t)} – ${y.format(a)}`}catch{r=e.block_start_local}return(0,s.jsxs)("li",{className:"flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950/60 px-4 py-3 text-sm",children:[(0,s.jsxs)("div",{children:[s.jsx("p",{className:"font-medium text-slate-100",children:r}),(0,s.jsxs)("p",{className:"text-xs text-slate-500",children:[e.accumulated_kwh.toFixed(2)," / ",e.target_kwh.toFixed(1)," kWh"]})]}),(0,s.jsxs)("span",{className:`text-sm font-semibold ${a>100?"text-danger":a>=80?"text-warning":"text-success"}`,children:[a.toFixed(1),"%"]})]},`${e.block_start_local}-${t}`)})})]})}let N=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"Asia/Kuala_Lumpur"});function k({connected:e,reconnecting:t,lastReadingTs:a,simulatorId:r}){let l="bg-slate-500",n="Disconnected";e?(l="bg-emerald-400 animate-pulse",n="Connected"):t&&(l="bg-amber-400 animate-pulse",n="Reconnecting");let i=a?N.format(new Date(a)):"—";return(0,s.jsxs)("div",{className:"rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-white",children:"Live status"}),(0,s.jsxs)("div",{className:"mt-4 flex items-center gap-3",children:[s.jsx("span",{className:`h-3 w-3 rounded-full ${l}`,"aria-hidden":"true"}),s.jsx("span",{className:"text-sm text-slate-200",children:n})]}),(0,s.jsxs)("dl",{className:"mt-4 space-y-2 text-xs text-slate-400",children:[(0,s.jsxs)("div",{children:[s.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-500",children:"Last reading"}),s.jsx("dd",{className:"mt-1 text-sm text-slate-200",children:i})]}),(0,s.jsxs)("div",{children:[s.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-500",children:"SSE endpoint"}),(0,s.jsxs)("dd",{className:"mt-1 text-sm text-slate-200",children:["/api/v1/stream/",r??"<id>"]})]})]})]})}var v=a(422);let _=new Intl.NumberFormat(void 0,{maximumFractionDigits:1});function T({simulatorId:e,simulatorName:t,targetKwh:a,initialBlock:n,initialHistory:i}){let[o,c]=(0,r.useState)("accumulate"),{history:d,loading:m,refresh:u}=(0,v.NX)(e,10,i),x=(0,r.useCallback)(()=>{u()},[u]),{block:h,loading:g,connected:p,reconnecting:f,lastReadingTs:w,refresh:y}=(0,v.AF)(e,{onWindowChange:x},n),N=h?.percent_of_target??0,T=N>100?"text-danger":N>=80?"text-warning":"text-success";return(0,s.jsxs)("section",{className:"space-y-10",children:[(0,s.jsxs)("header",{className:"flex flex-wrap items-end justify-between gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-500",children:"Simulator"}),s.jsx("h1",{className:"text-3xl font-semibold text-white",children:t}),s.jsx("p",{className:"text-sm text-slate-400",children:"Live chart and block history update in real time via server-sent events from the backend."})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4 text-sm text-slate-300",children:[(0,s.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[s.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Target"}),s.jsx("p",{className:"text-base font-semibold text-slate-100",children:a?`${a.toFixed(1)} kWh`:"—"})]}),(0,s.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-900/60 px-4 py-2 text-right",children:[s.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Current block"}),(0,s.jsxs)("p",{className:`text-base font-semibold ${T}`,children:[_.format(N),"%"]})]}),s.jsx(l.default,{href:{pathname:"/sim/[id]/run",query:{id:e}},className:"inline-flex items-center rounded-md bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground transition hover:bg-cyan-600",children:"Open controls"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[s.jsx("label",{className:"text-sm text-slate-300",children:"Chart Mode:"}),(0,s.jsxs)("select",{value:o,onChange:e=>c(e.target.value),className:"rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-100",children:[s.jsx("option",{value:"accumulate",children:"Accumulate"}),s.jsx("option",{value:"non-accumulate",children:"Non-Accumulate (Raw Readings)"})]})]})]}),(0,s.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[2fr,1fr]",children:[s.jsx(b,{block:h??{simulator_id:e,block_start_local:new Date().toISOString(),block_start_utc:new Date().toISOString(),block_end_utc:new Date().toISOString(),target_kwh:a??0,accumulated_kwh:0,percent_of_target:0,alerted_80pct:!1,chart_bins:{bin_seconds:30,points:[]}},loading:g,targetKwh:a,mode:o}),(0,s.jsxs)("div",{className:"flex flex-col gap-6",children:[s.jsx(k,{connected:p,reconnecting:f,lastReadingTs:w,simulatorId:e}),s.jsx(j,{history:d,loading:m})]})]}),(0,s.jsxs)("p",{className:"text-xs text-slate-500",children:["Timezone reference: ","Asia/Kuala_Lumpur",". SSE events automatically trigger a history refresh when the backend rolls to a new block."]})]})}},422:(e,t,a)=>{a.d(t,{AF:()=>i,NX:()=>o,a1:()=>n});var s=a(7577),r=a(8069),l=a(1004);function n(e=[]){let{push:t}=(0,l.p)(),[a,n]=(0,s.useState)(e),[i,o]=(0,s.useState)(0===e.length),[c,d]=(0,s.useState)(null),m=(0,s.useCallback)(async()=>{o(!0);try{let e=await (0,r.Mf)();n(e),d(null)}catch(a){let e=a instanceof Error?a.message:"Failed to load simulators";d(e),t({title:"Unable to load simulators",description:e,variant:"error"})}finally{o(!1)}},[t]),u=(0,s.useCallback)(async e=>{try{let a=await (0,r.ji)(e);return await m(),t({title:"Simulator created",description:`${a.name} is ready to run.`,variant:"success"}),a}catch(a){let e=a instanceof Error?a.message:"Failed to create simulator";throw console.error("Create simulator failed",a),t({title:"Create simulator failed",description:e,variant:"error"}),a}},[t,m]);return(0,s.useMemo)(()=>({simulators:a,loading:i,error:c,refresh:m,create:u}),[a,i,c,m,u])}function i(e,t={},a=null){let{push:n,dismiss:i}=(0,l.p)(),{onAlert80pct:o,onWindowChange:c}=t,[d,m]=(0,s.useState)({block:a,loading:!a&&!!e,error:null,connected:!1,reconnecting:!1});(0,s.useRef)(!1),(0,s.useRef)(null);let u=(0,s.useCallback)(async()=>{if(e){m(e=>({...e,loading:!0}));try{let t=await (0,r.lA)(e);m(e=>({...e,block:t,loading:!1,error:null}))}catch(t){let e=t instanceof Error?t.message:"Failed to load latest block";m(t=>({...t,loading:!1,error:e})),n({title:"Unable to load latest block",description:e,variant:"error"})}finally{m(e=>({...e,loading:!1}))}}},[e,n]);return{block:d.block,loading:d.loading,error:d.error,connected:d.connected,reconnecting:d.reconnecting,lastReadingTs:d.lastReadingTs,refresh:u}}function o(e,t=10,a=[]){let{push:n}=(0,l.p)(),[i,o]=(0,s.useState)(a),[c,d]=(0,s.useState)(!!e&&0===a.length),[m,u]=(0,s.useState)(null);return{history:i,loading:c,error:m,refresh:(0,s.useCallback)(async()=>{if(e){d(!0);try{let a=await (0,r.QY)(e,t);o(a),u(null)}catch(t){let e=t instanceof Error?t.message:"Failed to load block history";u(e),n({title:"Unable to load block history",description:e,variant:"error"})}finally{d(!1)}}},[t,n,e])}}},9905:(e,t,a)=>{a.d(t,{QY:()=>x,lA:()=>u,Mf:()=>m}),process.env.NEXT_PUBLIC_BACKEND_WRITE_TOKEN,process.env.NEXT_PUBLIC_BACKEND_KEY,process.env.NEXT_PUBLIC_BACKEND_API_KEY;let s="/api/bridge",r=new Set([429,500,502,503,504]);class l extends Error{constructor(e,t,a,s){super(e),this.status=t,this.code=a,this.details=s}}async function n(e){let t=await e.text();if(t)try{return JSON.parse(t)}catch(t){throw new l(`Invalid JSON response: ${t.message}`,e.status)}}async function i(e){let t;try{t=await e.clone().json()}catch{}if(!t)try{let t=await e.text();if(t)return new l(t,e.status)}catch{}let a=t?.error?.message??t?.message??e.statusText??`Request failed with status ${e.status}`,s=t?.error?.code,r=t?.error?.details;if(t&&t.detail){r=t.detail;try{if(Array.isArray(t.detail)){let e=t.detail.map(e=>e?.msg||e?.detail||"Validation error").filter(Boolean);e.length>0&&(a=e.join("; "))}else"string"==typeof t.detail&&(a=t.detail)}catch{}}return new l(a,e.status,s,r)}function o(e){return new Promise(t=>setTimeout(t,e))}async function c(e,t,a={}){let c=function(e){if(!s)throw new l("Backend base URL is not configured.",0);return e.startsWith("http")?e:`${s}${e}`}(e);c=`http://localhost${c}`;let d=a.retryDelays??[],m=0,u=new Headers(t?.headers);u.set("Accept","application/json");let x={...t,headers:u};for(;;)try{let e=await fetch(c,x);if(!e.ok){var h;let t=await i(e);if(h=e.status,r.has(h)&&m<d.length){await o(d[m++]);continue}throw t}if(204===e.status)return;return await n(e)}catch(e){if(e instanceof l)throw e;if(m<d.length){await o(d[m++]);continue}throw e}}async function d(e,t){try{return await c(e,t)}catch(a){if(!(a instanceof l))return await c(e,t,{retryDelays:[500]});throw a}}async function m(){let e=await d("/api/v1/simulators");return Array.isArray(e)?e:e.data??[]}async function u(e){return await d(`/api/v1/blocks/latest?simulator_id=${encodeURIComponent(e)}`)}async function x(e,t=10){let a=await d(`/api/v1/blocks/history?simulator_id=${encodeURIComponent(e)}&limit=${t}`);return Array.isArray(a)?a:a.data??[]}}};