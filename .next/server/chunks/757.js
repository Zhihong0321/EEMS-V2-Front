"use strict";exports.id=757,exports.ids=[757],exports.modules={62757:(e,t,s)=>{s.d(t,{fn:()=>B});var r,a=s(10326),i=s(17577),n=s(91664),l=s(41190),o=s(29752);function c(e){if(!e||"string"!=typeof e)return{isValid:!1,error:"Phone number is required"};let t=e.replace(/[\s\-\(\)\+]/g,"");return/^\d+$/.test(t)?t.length<10||t.length>15?{isValid:!1,error:"Phone number must be 10-15 digits including country code"}:t.match(/^(\d{1,4})/)?{isValid:!0,formattedNumber:t}:{isValid:!1,error:"Invalid country code format"}:{isValid:!1,error:"Phone number can only contain digits"}}function d(e){if(null==e||""===e)return{isValid:!1,error:"Threshold percentage is required"};let t="string"==typeof e?parseFloat(e):e;return isNaN(t)?{isValid:!1,error:"Threshold must be a valid number"}:t<1?{isValid:!1,error:"Threshold must be at least 1%"}:t>200?{isValid:!1,error:"Threshold cannot exceed 200%"}:{isValid:!0,normalizedValue:Math.round(10*t)/10}}function h(e){let t=c(e);if(!t.isValid||!t.formattedNumber)return e;let s=t.formattedNumber;return s.length<=13?s.replace(/(\d{1,3})(\d{3})(\d{3})(\d+)/,"$1 $2 $3 $4"):s}!function(e){e.WHATSAPP_API_UNAVAILABLE="WHATSAPP_API_UNAVAILABLE",e.INVALID_PHONE_NUMBER="INVALID_PHONE_NUMBER",e.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",e.STORAGE_ERROR="STORAGE_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR",e.DUPLICATE_TRIGGER="DUPLICATE_TRIGGER",e.COOLDOWN_ACTIVE="COOLDOWN_ACTIVE"}(r||(r={}));let m={TRIGGERS:"notification_triggers",HISTORY:"notification_history",SETTINGS:"notification_settings",COOLDOWNS:"notification_cooldowns"},u={cooldownMinutes:15,maxDailyNotifications:10,enabledGlobally:!0};class g{safeParseJSON(e,t){try{let s=localStorage.getItem(e);if(null===s)return t;return JSON.parse(s)}catch(s){return console.error(`Error parsing localStorage item ${e}:`,s),t}}safeSaveJSON(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(t){throw console.error(`Error saving to localStorage ${e}:`,t),Error(`Storage error: ${t instanceof Error?t.message:"Unknown error"}`)}}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async saveTrigger(e){let t=this.safeParseJSON(m.TRIGGERS,[]);if(t.find(t=>t.simulatorId===e.simulatorId&&t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage&&t.id!==e.id))throw Error("A trigger with the same simulator, phone number, and threshold already exists");let s=t.findIndex(t=>t.id===e.id);s>=0?t[s]=e:t.push(e),this.safeSaveJSON(m.TRIGGERS,t)}async getTrigger(e){return this.safeParseJSON(m.TRIGGERS,[]).find(t=>t.id===e)||null}async getTriggersBySimulator(e){return this.safeParseJSON(m.TRIGGERS,[]).filter(t=>t.simulatorId===e)}async getAllTriggers(){return this.safeParseJSON(m.TRIGGERS,[])}async updateTrigger(e,t){let s=this.safeParseJSON(m.TRIGGERS,[]),r=s.findIndex(t=>t.id===e);if(-1===r)throw Error(`Trigger with id ${e} not found`);s[r]={...s[r],...t,updatedAt:new Date().toISOString()},this.safeSaveJSON(m.TRIGGERS,s)}async deleteTrigger(e){let t=this.safeParseJSON(m.TRIGGERS,[]),s=t.filter(t=>t.id!==e);if(t.length===s.length)throw Error(`Trigger with id ${e} not found`);this.safeSaveJSON(m.TRIGGERS,s);let r=this.safeParseJSON(m.COOLDOWNS,{});delete r[e],this.safeSaveJSON(m.COOLDOWNS,r)}async saveNotificationHistory(e){let t=this.safeParseJSON(m.HISTORY,[]);t.push(e),t.length>1e3&&t.splice(0,t.length-1e3),this.safeSaveJSON(m.HISTORY,t)}async getNotificationHistory(e,t=100){return this.safeParseJSON(m.HISTORY,[]).filter(t=>t.simulatorId===e).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,t)}async getAllNotificationHistory(e=100){return this.safeParseJSON(m.HISTORY,[]).sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,e)}async getSettings(){return this.safeParseJSON(m.SETTINGS,u)}async updateSettings(e){let t={...await this.getSettings(),...e};this.safeSaveJSON(m.SETTINGS,t)}async getLastNotificationTime(e){let t=this.safeParseJSON(m.COOLDOWNS,{})[e];return t?new Date(t):null}async setLastNotificationTime(e,t){let s=this.safeParseJSON(m.COOLDOWNS,{});s[e]=t.toISOString(),this.safeSaveJSON(m.COOLDOWNS,s)}async clearAllData(){Object.values(m).forEach(e=>{localStorage.removeItem(e)})}async exportData(){return JSON.stringify({triggers:this.safeParseJSON(m.TRIGGERS,[]),history:this.safeParseJSON(m.HISTORY,[]),settings:this.safeParseJSON(m.SETTINGS,u),cooldowns:this.safeParseJSON(m.COOLDOWNS,{}),exportedAt:new Date().toISOString()},null,2)}async importData(e){try{let t=JSON.parse(e);t.triggers&&this.safeSaveJSON(m.TRIGGERS,t.triggers),t.history&&this.safeSaveJSON(m.HISTORY,t.history),t.settings&&this.safeSaveJSON(m.SETTINGS,t.settings),t.cooldowns&&this.safeSaveJSON(m.COOLDOWNS,t.cooldowns)}catch(e){throw Error(`Invalid import data: ${e instanceof Error?e.message:"Unknown error"}`)}}}function x(e,t,s,r){return{id:`history-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,triggerId:e.id,simulatorId:e.simulatorId,phoneNumber:e.phoneNumber,thresholdPercentage:e.thresholdPercentage,actualPercentage:t,sentAt:new Date().toISOString(),success:s,errorMessage:r}}new g;var f=s(94337);class p extends Error{constructor(e,t,s){super(t),this.name="NotificationValidationError",this.type=e,this.field=s,this.code=e}}class b extends Error{constructor(e,t){super(e),this.name="NotificationStorageError",this.type=r.STORAGE_ERROR,this.operation=t}}class N extends Error{constructor(e,t){super(e),this.name="NotificationRateLimitError",this.type=r.RATE_LIMIT_EXCEEDED,this.waitTimeMinutes=t}}class y extends Error{constructor(e,t,s=!0){super(e),this.name="NotificationWhatsAppError",this.type=r.WHATSAPP_API_UNAVAILABLE,this.apiError=t,this.retryable=s}}class w{handleError(e,t){let s=t||"general",a=this.errorCounts.get(s)||0;return(this.errorCounts.set(s,a+1),this.lastErrors.set(s,new Date),e instanceof p)?{type:e.type,message:e.message,shouldRetry:!1}:e instanceof N?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:e.waitTimeMinutes}:e instanceof y?{type:e.type,message:e.message,shouldRetry:e.retryable,retryAfterMinutes:e.retryable?5:void 0}:e instanceof b?{type:e.type,message:e.message,shouldRetry:!0,retryAfterMinutes:1}:e.message.includes("localStorage")?{type:r.STORAGE_ERROR,message:"Storage is not available or full",shouldRetry:!1}:e.message.includes("network")||e.message.includes("fetch")?{type:r.WHATSAPP_API_UNAVAILABLE,message:"Network error occurred",shouldRetry:!0,retryAfterMinutes:2}:{type:r.VALIDATION_ERROR,message:e.message||"Unknown error occurred",shouldRetry:!1}}getErrorStats(){let e=Array.from(this.errorCounts.values()).reduce((e,t)=>e+t,0),t={},s={};return this.errorCounts.forEach((e,s)=>{t[s]=e}),this.lastErrors.forEach((e,t)=>{s[t]=e}),{totalErrors:e,errorsByContext:t,recentErrors:s}}clearErrorStats(){this.errorCounts.clear(),this.lastErrors.clear()}hasTooManyErrors(e,t=10,s=60){let r=this.errorCounts.get(e)||0,a=this.lastErrors.get(e);return!!a&&!(r<t)&&(Date.now()-a.getTime())/6e4<s}constructor(){this.errorCounts=new Map,this.lastErrors=new Map}}class j{static validatePhoneNumber(e){if(!e||"string"!=typeof e)throw new p(r.INVALID_PHONE_NUMBER,"Phone number is required","phoneNumber");let t=e.replace(/[\s\-\(\)]/g,""),s=t.startsWith("+")?t.substring(1):t;if(!/^\d+$/.test(s))throw new p(r.INVALID_PHONE_NUMBER,"Phone number can only contain digits after country code","phoneNumber");if(s.length<10||s.length>15)throw new p(r.INVALID_PHONE_NUMBER,"Phone number must be 10-15 digits including country code","phoneNumber");if(["000","111","222","333","444","555","666","777","888","999"].includes(s.substring(0,3)))throw new p(r.INVALID_PHONE_NUMBER,"Invalid country code","phoneNumber")}static validateThresholdPercentage(e){if(null==e)throw new p(r.VALIDATION_ERROR,"Threshold percentage is required","thresholdPercentage");if("number"!=typeof e||isNaN(e))throw new p(r.VALIDATION_ERROR,"Threshold must be a valid number","thresholdPercentage");if(e<1)throw new p(r.VALIDATION_ERROR,"Threshold must be at least 1%","thresholdPercentage");if(e>200)throw new p(r.VALIDATION_ERROR,"Threshold cannot exceed 200%","thresholdPercentage");if((e.toString().split(".")[1]||"").length>1)throw new p(r.VALIDATION_ERROR,"Threshold can have at most 1 decimal place","thresholdPercentage")}static validateSimulatorId(e){if(!e||"string"!=typeof e)throw new p(r.VALIDATION_ERROR,"Simulator ID is required","simulatorId");if(0===e.trim().length)throw new p(r.VALIDATION_ERROR,"Simulator ID cannot be empty","simulatorId");if(e.length>100)throw new p(r.VALIDATION_ERROR,"Simulator ID is too long (max 100 characters)","simulatorId");if(!/^[a-zA-Z0-9\-_]+$/.test(e))throw new p(r.VALIDATION_ERROR,"Simulator ID can only contain letters, numbers, hyphens, and underscores","simulatorId")}static validateNotificationSettings(e){if("object"!=typeof e||null===e)throw new p(r.VALIDATION_ERROR,"Settings must be an object","settings");if(void 0!==e.cooldownMinutes){if("number"!=typeof e.cooldownMinutes||isNaN(e.cooldownMinutes))throw new p(r.VALIDATION_ERROR,"Cooldown minutes must be a number","cooldownMinutes");if(e.cooldownMinutes<1||e.cooldownMinutes>1440)throw new p(r.VALIDATION_ERROR,"Cooldown minutes must be between 1 and 1440 (24 hours)","cooldownMinutes")}if(void 0!==e.maxDailyNotifications){if("number"!=typeof e.maxDailyNotifications||isNaN(e.maxDailyNotifications))throw new p(r.VALIDATION_ERROR,"Max daily notifications must be a number","maxDailyNotifications");if(e.maxDailyNotifications<1||e.maxDailyNotifications>100)throw new p(r.VALIDATION_ERROR,"Max daily notifications must be between 1 and 100","maxDailyNotifications")}if(void 0!==e.enabledGlobally&&"boolean"!=typeof e.enabledGlobally)throw new p(r.VALIDATION_ERROR,"Enabled globally must be a boolean","enabledGlobally")}static validateTriggerData(e){if("object"!=typeof e||null===e)throw new p(r.VALIDATION_ERROR,"Trigger data must be an object");if(this.validateSimulatorId(e.simulatorId),this.validatePhoneNumber(e.phoneNumber),this.validateThresholdPercentage(e.thresholdPercentage),void 0!==e.isActive&&"boolean"!=typeof e.isActive)throw new p(r.VALIDATION_ERROR,"isActive must be a boolean","isActive")}}class v{static handleWhatsAppError(e,t){let s="WhatsApp API error occurred",r=!0,a="";if(e&&"object"==typeof e&&(e.message&&(a=e.message,s=`WhatsApp API error: ${e.message}`),e.code))switch(e.code){case"PHONE_NOT_WHATSAPP":s=`Phone number ${t} is not registered with WhatsApp`,r=!1;break;case"RATE_LIMIT":s="WhatsApp API rate limit exceeded",r=!0;break;case"INVALID_PHONE":s=`Invalid phone number format: ${t}`,r=!1;break;case"API_UNAVAILABLE":s="WhatsApp API is temporarily unavailable",r=!0;break;case"AUTHENTICATION_FAILED":s="WhatsApp API authentication failed",r=!1;break;default:s=`WhatsApp API error (${e.code}): ${e.message||"Unknown error"}`}return new y(s,a,r)}static isRetryableError(e){return e instanceof y?e.retryable:!!(e.message.includes("network")||e.message.includes("timeout")||e.message.includes("fetch"))}static getRetryDelay(e,t){return e instanceof N?Math.min(6e4*e.waitTimeMinutes,3e5):Math.min(1e3*Math.pow(2,t-1),3e5)}}let S=new w;class A{constructor(e){this.storage=e||new g}async createTrigger(e){try{if(j.validateTriggerData(e),(await this.storage.getTriggersBySimulator(e.simulatorId)).find(t=>t.phoneNumber===e.phoneNumber&&t.thresholdPercentage===e.thresholdPercentage))throw new p(r.DUPLICATE_TRIGGER,"A trigger with the same phone number and threshold already exists for this simulator");let t=function(e){let t=new Date().toISOString();return{id:`trigger-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,createdAt:t,updatedAt:t,...e}}(e);return await this.storage.saveTrigger(t),t}catch(e){throw S.handleError(e,"createTrigger"),e}}async updateTrigger(e,t){let s=await this.storage.getTrigger(e);if(!s)throw Error(`Trigger with id ${e} not found`);if(t.phoneNumber||t.thresholdPercentage||t.simulatorId){let r={phoneNumber:t.phoneNumber||s.phoneNumber,thresholdPercentage:t.thresholdPercentage||s.thresholdPercentage,simulatorId:t.simulatorId||s.simulatorId},a=function(e){let t=[],s=c(e.phoneNumber);s.isValid||t.push(s.error);let r=d(e.thresholdPercentage);return r.isValid||t.push(r.error),e.simulatorId&&"string"==typeof e.simulatorId&&0!==e.simulatorId.trim().length||t.push("Simulator ID is required"),{isValid:0===t.length,errors:t}}(r);if(!a.isValid)throw Error(`Validation failed: ${a.errors.join(", ")}`);if((await this.storage.getTriggersBySimulator(r.simulatorId)).find(t=>t.id!==e&&t.phoneNumber===r.phoneNumber&&t.thresholdPercentage===r.thresholdPercentage))throw Error("A trigger with the same phone number and threshold already exists for this simulator")}await this.storage.updateTrigger(e,t);let r=await this.storage.getTrigger(e);if(!r)throw Error("Failed to retrieve updated trigger");return r}async deleteTrigger(e){if(!await this.storage.getTrigger(e))throw Error(`Trigger with id ${e} not found`);await this.storage.deleteTrigger(e)}async getTrigger(e){return await this.storage.getTrigger(e)}async getTriggersBySimulator(e){return await this.storage.getTriggersBySimulator(e)}async getAllTriggers(){return await this.storage.getAllTriggers()}async getActiveTriggersBySimulator(e){return(await this.storage.getTriggersBySimulator(e)).filter(e=>e.isActive)}async checkThresholds(e,t){try{let s=await this.storage.getSettings();if(!s.enabledGlobally)return;for(let r of(await this.getActiveTriggersBySimulator(e)))t>=r.thresholdPercentage&&await this.processTrigger(r,t,s)}catch(e){console.error("Error checking thresholds:",e)}}async processTrigger(e,t,s){try{let r=await this.storage.getLastNotificationTime(e.id);if(r&&(Date.now()-r.getTime())/6e4<s.cooldownMinutes)return;let a=new Date;if(a.setHours(0,0,0,0),(await this.getTodayNotificationHistory(e.id,a)).length>=s.maxDailyNotifications)return;let i=await this.sendNotification(e,t),n=x(e,t,i,i?void 0:"Failed to send WhatsApp message");await this.storage.saveNotificationHistory(n),i&&await this.storage.setLastNotificationTime(e.id,new Date)}catch(r){console.error("Error processing trigger:",r);let s=x(e,t,!1,r instanceof Error?r.message:"Unknown error");await this.storage.saveNotificationHistory(s)}}async sendNotification(e,t){try{if(!(await (0,f.n_)()).ready)throw v.handleWhatsAppError({code:"API_UNAVAILABLE",message:"WhatsApp API is not ready"},e.phoneNumber);let s=this.createNotificationMessage(e.simulatorId,t,e.thresholdPercentage),r=await (0,f.U3)({to:e.phoneNumber,message:s});if(!r.success)throw v.handleWhatsAppError({message:r.error||"Failed to send WhatsApp message"},e.phoneNumber);return!0}catch(e){return console.error("Failed to send notification:",S.handleError(e,"sendNotification").message),!1}}createNotificationMessage(e,t,s){let r=new Date().toLocaleString();return`ðŸš¨ EMS Alert: Energy Usage Threshold Exceeded

Simulator: ${e}
Current Usage: ${t.toFixed(1)}% of target
Threshold: ${s}%

Time: ${r}

Please check your energy consumption and take appropriate action.`}async getNotificationHistory(e,t){return await this.storage.getNotificationHistory(e,t)}async getAllNotificationHistory(e){return await this.storage.getAllNotificationHistory(e)}async getTodayNotificationHistory(e,t){let s=await this.storage.getAllNotificationHistory(1e3),r=new Date(t);return r.setDate(r.getDate()+1),s.filter(s=>{let a=new Date(s.sentAt);return s.triggerId===e&&a>=t&&a<r})}async getSettings(){return await this.storage.getSettings()}async updateSettings(e){try{return j.validateNotificationSettings(e),await this.storage.updateSettings(e),await this.storage.getSettings()}catch(e){throw S.handleError(e,"updateSettings"),e}}async getSystemStatus(){try{let[e,t,s,r]=await Promise.all([(0,f.n_)(),this.getAllTriggers(),this.getSettings(),this.getAllNotificationHistory(50)]),a=t.filter(e=>e.isActive),i=new Date(Date.now()-864e5),n=r.filter(e=>new Date(e.sentAt)>i).length;return{whatsappReady:e.ready,totalTriggers:t.length,activeTriggers:a.length,notificationsEnabled:s.enabledGlobally,recentNotifications:n}}catch(e){return console.error("Error getting system status:",e),{whatsappReady:!1,totalTriggers:0,activeTriggers:0,notificationsEnabled:!1,recentNotifications:0}}}async toggleTrigger(e,t){return await this.updateTrigger(e,{isActive:t})}async bulkToggleTriggers(e,t){for(let s of(await this.getTriggersBySimulator(e)))await this.updateTrigger(s.id,{isActive:t})}async clearNotificationHistory(e){if(e)throw(await this.storage.getAllNotificationHistory(1e4)).filter(t=>t.simulatorId!==e),Error("Selective history clearing not yet implemented");await this.storage.clearAllData()}}let E=new A;function T({simulatorId:e,trigger:t,onSave:s,onCancel:r,isLoading:m=!1}){let[u,g]=(0,i.useState)({phoneNumber:t?.phoneNumber||"",thresholdPercentage:t?.thresholdPercentage?.toString()||"",isActive:t?.isActive??!0}),[x,f]=(0,i.useState)({}),[p,b]=(0,i.useState)(!1),[N,y]=(0,i.useState)(!1),w=!!t,j=(e,t)=>{switch(e){case"phoneNumber":if(!t||"string"!=typeof t||""===t.trim())return"Phone number is required";let s=c(t);return s.isValid?void 0:s.error;case"thresholdPercentage":if(!t||"string"!=typeof t||""===t.trim())return"Threshold percentage is required";let r=d(t);return r.isValid?void 0:r.error;default:return}},v=(e,t)=>{if(g(s=>({...s,[e]:t})),y(!0),x[e]&&f(t=>({...t,[e]:void 0})),"phoneNumber"===e||"thresholdPercentage"===e){let s=j(e,t);s&&f(t=>({...t,[e]:s}))}},S=()=>{let e={},t=j("phoneNumber",u.phoneNumber);t&&(e.phoneNumber=t);let s=j("thresholdPercentage",u.thresholdPercentage);return s&&(e.thresholdPercentage=s),f(e),0===Object.keys(e).length},A=async r=>{if(r.preventDefault(),S()){b(!0),f({});try{let r=parseFloat(u.thresholdPercentage);if(w&&t){let e={phoneNumber:u.phoneNumber,thresholdPercentage:r,isActive:u.isActive},a=await E.updateTrigger(t.id,e);s(a)}else{let t={simulatorId:e,phoneNumber:u.phoneNumber,thresholdPercentage:r,isActive:u.isActive},a=await E.createTrigger(t);s(a)}}catch(e){console.error("Error saving trigger:",e),f({general:e instanceof Error?e.message:"Failed to save trigger"})}finally{b(!1)}}};return(0,a.jsxs)(o.Zb,{children:[(0,a.jsxs)(o.Ol,{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:w?"Edit Notification Trigger":"Create Notification Trigger"}),a.jsx("p",{className:"text-sm text-slate-400",children:w?"Update the notification settings for this trigger":"Set up a new WhatsApp notification when energy usage exceeds the threshold"})]}),a.jsx(o.aY,{children:(0,a.jsxs)("form",{onSubmit:A,className:"space-y-6",children:[x.general&&a.jsx("div",{className:"p-3 rounded-md bg-danger/10 border border-danger/20",children:a.jsx("p",{className:"text-sm text-danger",children:x.general})}),a.jsx(l.SP,{label:"WhatsApp Phone Number",error:x.phoneNumber,helperText:"Enter phone number with country code (e.g., 60123456789)",required:!0,children:a.jsx(l.II,{type:"tel",value:u.phoneNumber,onChange:e=>v("phoneNumber",e.target.value),placeholder:"60123456789",error:!!x.phoneNumber,disabled:p||m})}),u.phoneNumber&&!x.phoneNumber&&(0,a.jsxs)("div",{className:"text-xs text-slate-400",children:["Formatted: ",(e=>{if(!e)return e;let t=c(e);return t.isValid&&t.formattedNumber?h(t.formattedNumber):e})(u.phoneNumber)]}),a.jsx(l.SP,{label:"Threshold Percentage",error:x.thresholdPercentage,helperText:"Notification will be sent when usage reaches this percentage (1-200%)",required:!0,children:(0,a.jsxs)("div",{className:"relative",children:[a.jsx(l.II,{type:"number",min:"1",max:"200",step:"0.1",value:u.thresholdPercentage,onChange:e=>v("thresholdPercentage",e.target.value),placeholder:"80",error:!!x.thresholdPercentage,disabled:p||m,className:"pr-8"}),a.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm",children:"%"})]})}),a.jsx(l.SP,{label:"Status",helperText:"Enable or disable this notification trigger",children:(0,a.jsxs)(l.Ph,{value:u.isActive?"active":"inactive",onChange:e=>v("isActive","active"===e.target.value),disabled:p||m,children:[a.jsx("option",{value:"active",children:"Active - Notifications enabled"}),a.jsx("option",{value:"inactive",children:"Inactive - Notifications disabled"})]})}),(0,a.jsxs)("div",{className:"flex gap-3 pt-4",children:[a.jsx(n.z,{type:"submit",isLoading:p,disabled:m||Object.keys(x).length>0,className:"flex-1",children:p?w?"Updating...":"Creating...":w?"Update Trigger":"Create Trigger"}),a.jsx(n.z,{type:"button",variant:"secondary",onClick:()=>{(!N||window.confirm("You have unsaved changes. Are you sure you want to cancel?"))&&r()},disabled:p||m,children:"Cancel"})]})]})})]})}var I=s(83401);let R=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}),O=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.636 5.636a9 9 0 1 0 12.728 0M12 3v9"}))}),D=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"}))}),P=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"}))});var L=s(19381),C=s(41135);function k({trigger:e,onEdit:t,onDelete:s,onToggle:r,isLoading:l}){let[c,d]=(0,i.useState)(!1),[m,u]=(0,i.useState)(!1),g=async()=>{if(window.confirm(`Are you sure you want to delete this notification trigger?

Phone: ${h(e.phoneNumber)}
Threshold: ${e.thresholdPercentage}%

This action cannot be undone.`)){d(!0);try{await s(e.id)}catch(e){console.error("Error deleting trigger:",e)}finally{d(!1)}}},x=async()=>{u(!0);try{await r(e.id,!e.isActive)}catch(e){console.error("Error toggling trigger:",e)}finally{u(!1)}},f=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return a.jsx(o.Zb,{className:(0,C.Z)("transition-all duration-200",e.isActive?"border-slate-700 bg-slate-900/60":"border-slate-800 bg-slate-900/30 opacity-75"),children:a.jsx(o.aY,{className:"p-4",children:(0,a.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsxs)("div",{className:(0,C.Z)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium",e.isActive?"bg-success/10 text-success border border-success/20":"bg-slate-700/50 text-slate-400 border border-slate-700"),children:[e.isActive?a.jsx(I.Z,{className:"h-3 w-3"}):a.jsx(R,{className:"h-3 w-3"}),e.isActive?"Active":"Inactive"]}),(0,a.jsxs)("div",{className:"px-2 py-1 rounded-full bg-primary/10 text-primary border border-primary/20 text-xs font-medium",children:[e.thresholdPercentage,"% threshold"]})]}),(0,a.jsxs)("div",{className:"mb-2",children:[a.jsx("p",{className:"text-sm font-medium text-white",children:h(e.phoneNumber)}),(0,a.jsxs)("p",{className:"text-xs text-slate-400",children:["WhatsApp notifications when usage â‰¥ ",e.thresholdPercentage,"%"]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-4 text-xs text-slate-500",children:[(0,a.jsxs)("span",{children:["Created: ",f(e.createdAt)]}),e.updatedAt!==e.createdAt&&(0,a.jsxs)("span",{children:["Updated: ",f(e.updatedAt)]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(n.z,{variant:"ghost",size:"sm",onClick:x,disabled:l||m||c,isLoading:m,className:(0,C.Z)("h-8 w-8 p-0",e.isActive?"text-slate-400 hover:text-orange-400":"text-slate-500 hover:text-success"),title:e.isActive?"Disable notifications":"Enable notifications",children:a.jsx(O,{className:"h-4 w-4"})}),a.jsx(n.z,{variant:"ghost",size:"sm",onClick:()=>t(e),disabled:l||m||c,className:"h-8 w-8 p-0 text-slate-400 hover:text-primary",title:"Edit trigger",children:a.jsx(D,{className:"h-4 w-4"})}),a.jsx(n.z,{variant:"ghost",size:"sm",onClick:g,disabled:l||m||c,isLoading:c,className:"h-8 w-8 p-0 text-slate-400 hover:text-danger",title:"Delete trigger",children:a.jsx(P,{className:"h-4 w-4"})})]})]})})})}function M({triggers:e,onEdit:t,onDelete:s,onToggle:r,isLoading:l=!1}){let[c,d]=(0,i.useState)("created"),[h,m]=(0,i.useState)("all"),u=e.filter(e=>"all"===h||("active"===h?e.isActive:!e.isActive)).sort((e,t)=>{switch(c){case"threshold":return e.thresholdPercentage-t.thresholdPercentage;case"status":return Number(t.isActive)-Number(e.isActive);default:return new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()}}),g=e.filter(e=>e.isActive).length,x=e.filter(e=>!e.isActive).length;return 0===e.length?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx(L.Z,{className:"h-12 w-12 text-slate-500 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"No Notification Triggers"}),a.jsx("p",{className:"text-slate-400 mb-4",children:"You haven't set up any WhatsApp notification triggers yet."}),a.jsx("p",{className:"text-sm text-slate-500",children:"Create your first trigger to receive alerts when energy usage exceeds your specified thresholds."})]})}):(0,a.jsxs)("div",{className:"space-y-4",children:[a.jsx(o.Zb,{children:a.jsx(o.Ol,{className:"pb-4",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification Triggers"}),(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm text-slate-400 mt-1",children:[(0,a.jsxs)("span",{children:[e.length," total"]}),(0,a.jsxs)("span",{className:"text-success",children:[g," active"]}),(0,a.jsxs)("span",{className:"text-slate-500",children:[x," inactive"]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("select",{value:h,onChange:e=>m(e.target.value),className:"px-3 py-1.5 text-sm rounded-md border border-slate-700 bg-slate-800 text-white focus:border-primary focus:outline-none",disabled:l,children:[a.jsx("option",{value:"all",children:"All Status"}),a.jsx("option",{value:"active",children:"Active Only"}),a.jsx("option",{value:"inactive",children:"Inactive Only"})]}),(0,a.jsxs)("select",{value:c,onChange:e=>d(e.target.value),className:"px-3 py-1.5 text-sm rounded-md border border-slate-700 bg-slate-800 text-white focus:border-primary focus:outline-none",disabled:l,children:[a.jsx("option",{value:"created",children:"Sort by Created"}),a.jsx("option",{value:"threshold",children:"Sort by Threshold"}),a.jsx("option",{value:"status",children:"Sort by Status"})]})]})]})})}),0===u.length?a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-6 text-center",children:a.jsx("p",{className:"text-slate-400",children:"No triggers match the current filter criteria."})})}):a.jsx("div",{className:"space-y-3",children:u.map(e=>a.jsx(k,{trigger:e,onEdit:t,onDelete:s,onToggle:r,isLoading:l},e.id))}),e.length>1&&a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm text-slate-400",children:"Bulk Actions"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[a.jsx(n.z,{variant:"ghost",size:"sm",onClick:()=>{let t=e.filter(e=>!e.isActive);0!==t.length&&window.confirm(`Enable notifications for ${t.length} inactive trigger(s)?`)&&t.forEach(e=>r(e.id,!0))},disabled:l||0===x,className:"text-success hover:text-success",children:"Enable All"}),a.jsx(n.z,{variant:"ghost",size:"sm",onClick:()=>{let t=e.filter(e=>e.isActive);0!==t.length&&window.confirm(`Disable notifications for ${t.length} active trigger(s)?`)&&t.forEach(e=>r(e.id,!1))},disabled:l||0===g,className:"text-orange-400 hover:text-orange-300",children:"Disable All"})]})]})})})]})}var _=s(36902);let G=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z"}))});var V=s(42553);function Z({history:e}){let[t,s]=(0,i.useState)(!1);return a.jsx(o.Zb,{className:(0,C.Z)("transition-all duration-200",e.success?"border-slate-700 bg-slate-900/60":"border-red-900/30 bg-red-900/10"),children:a.jsx(o.aY,{className:"p-4",children:a.jsx("div",{className:"flex items-start justify-between gap-4",children:(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,a.jsxs)("div",{className:(0,C.Z)("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium border",e.success?"text-success bg-success/10 border-success/20":"text-danger bg-danger/10 border-danger/20"),children:[e.success?a.jsx(I.Z,{className:"h-3 w-3"}):a.jsx(_.Z,{className:"h-3 w-3"}),e.success?"Sent":"Failed"]}),(0,a.jsxs)("div",{className:"px-2 py-1 rounded-full bg-slate-700/50 text-slate-300 text-xs",children:[e.actualPercentage.toFixed(1),"% / ",e.thresholdPercentage,"%"]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs text-slate-500",children:[a.jsx(R,{className:"h-3 w-3"}),(e=>{let t=new Date(e),s=new Date,r=s.getTime()-t.getTime(),a=Math.floor(r/6e4),i=Math.floor(r/36e5),n=Math.floor(r/864e5);return a<1?"Just now":a<60?`${a}m ago`:i<24?`${i}h ago`:n<7?`${n}d ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==s.getFullYear()?"numeric":void 0,hour:"2-digit",minute:"2-digit"})})(e.sentAt)]})]}),(0,a.jsxs)("div",{className:"mb-2",children:[a.jsx("p",{className:"text-sm font-medium text-white",children:h(e.phoneNumber)}),(0,a.jsxs)("p",{className:"text-xs text-slate-400",children:["Usage reached ",e.actualPercentage.toFixed(1),"% (threshold: ",e.thresholdPercentage,"%)"]})]}),!e.success&&e.errorMessage&&a.jsx("div",{className:"mt-2 p-2 rounded bg-red-900/20 border border-red-900/30",children:(0,a.jsxs)("p",{className:"text-xs text-red-300",children:["Error: ",e.errorMessage]})}),!e.success&&a.jsx("button",{onClick:()=>s(!t),className:"mt-2 text-xs text-slate-400 hover:text-slate-300 underline",children:t?"Hide Details":"Show Details"}),t&&!e.success&&a.jsx("div",{className:"mt-2 p-3 rounded bg-slate-800/50 border border-slate-700",children:(0,a.jsxs)("div",{className:"space-y-2 text-xs",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-slate-400",children:"Trigger ID:"}),a.jsx("span",{className:"ml-2 text-slate-300 font-mono",children:e.triggerId})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-slate-400",children:"Simulator ID:"}),a.jsx("span",{className:"ml-2 text-slate-300 font-mono",children:e.simulatorId})]}),(0,a.jsxs)("div",{children:[a.jsx("span",{className:"text-slate-400",children:"Sent At:"}),a.jsx("span",{className:"ml-2 text-slate-300",children:new Date(e.sentAt).toLocaleString()})]})]})})]})})})})}function H({simulatorId:e,limit:t=50}){let[s,r]=(0,i.useState)([]),[l,c]=(0,i.useState)(!0),[d,h]=(0,i.useState)(null),[m,u]=(0,i.useState)({status:"all",timeRange:"all"}),g=async()=>{try{c(!0),h(null);let s=await E.getNotificationHistory(e,t);r(s)}catch(e){console.error("Error loading notification history:",e),h(e instanceof Error?e.message:"Failed to load notification history")}finally{c(!1)}},x=s.filter(e=>{if("all"!==m.status&&!("success"===m.status?e.success:!e.success))return!1;if("all"!==m.timeRange){let t=new Date,s=new Date(e.sentAt),r=t.getTime()-s.getTime();switch(m.timeRange){case"24h":if(r>864e5)return!1;break;case"7d":if(r>6048e5)return!1;break;case"30d":if(r>2592e6)return!1}}return!0}),f=s.filter(e=>e.success).length,p=s.filter(e=>!e.success).length;return l?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),a.jsx("p",{className:"text-slate-400",children:"Loading notification history..."})]})}):d?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx(L.Z,{className:"h-12 w-12 text-danger mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Error Loading History"}),a.jsx("p",{className:"text-slate-400 mb-4",children:d}),a.jsx(n.z,{onClick:g,variant:"secondary",children:"Try Again"})]})}):0===s.length?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx(R,{className:"h-12 w-12 text-slate-500 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"No Notification History"}),a.jsx("p",{className:"text-slate-400 mb-4",children:"No notifications have been sent for this simulator yet."}),a.jsx("p",{className:"text-sm text-slate-500",children:"History will appear here once notification triggers are activated and thresholds are exceeded."})]})}):(0,a.jsxs)("div",{className:"space-y-4",children:[a.jsx(o.Zb,{children:a.jsx(o.Ol,{className:"pb-4",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification History"}),(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm text-slate-400 mt-1",children:[(0,a.jsxs)("span",{children:[s.length," total"]}),(0,a.jsxs)("span",{className:"text-success",children:[f," sent"]}),(0,a.jsxs)("span",{className:"text-danger",children:[p," failed"]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx(G,{className:"h-4 w-4 text-slate-400"}),(0,a.jsxs)("select",{value:m.status,onChange:e=>u(t=>({...t,status:e.target.value})),className:"px-3 py-1.5 text-sm rounded-md border border-slate-700 bg-slate-800 text-white focus:border-primary focus:outline-none",children:[a.jsx("option",{value:"all",children:"All Status"}),a.jsx("option",{value:"success",children:"Sent Only"}),a.jsx("option",{value:"failed",children:"Failed Only"})]})]}),(0,a.jsxs)("select",{value:m.timeRange,onChange:e=>u(t=>({...t,timeRange:e.target.value})),className:"px-3 py-1.5 text-sm rounded-md border border-slate-700 bg-slate-800 text-white focus:border-primary focus:outline-none",children:[a.jsx("option",{value:"all",children:"All Time"}),a.jsx("option",{value:"24h",children:"Last 24 Hours"}),a.jsx("option",{value:"7d",children:"Last 7 Days"}),a.jsx("option",{value:"30d",children:"Last 30 Days"})]}),(0,a.jsxs)(n.z,{variant:"ghost",size:"sm",onClick:()=>{let t=new Blob([["Date,Phone Number,Threshold %,Actual %,Status,Error Message",...x.map(e=>[new Date(e.sentAt).toISOString(),e.phoneNumber,e.thresholdPercentage,e.actualPercentage.toFixed(1),e.success?"Success":"Failed",e.errorMessage||""].map(e=>`"${e}"`).join(","))].join("\n")],{type:"text/csv"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`notification-history-${e}-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)},disabled:0===x.length,className:"flex items-center gap-2",children:[a.jsx(V.Z,{className:"h-4 w-4"}),"Export CSV"]})]})]})})}),0===x.length?a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-6 text-center",children:a.jsx("p",{className:"text-slate-400",children:"No notifications match the current filter criteria."})})}):a.jsx("div",{className:"space-y-3",children:x.map(e=>a.jsx(Z,{history:e},e.id))}),s.length>=t&&a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-4 text-center",children:a.jsx(n.z,{variant:"ghost",onClick:()=>g(),className:"text-slate-400 hover:text-white",children:"Load More History"})})})]})}function $({settings:e,onSave:t,onCancel:s,isLoading:r=!1}){let[c,d]=(0,i.useState)({enabledGlobally:e.enabledGlobally,cooldownMinutes:e.cooldownMinutes.toString(),maxDailyNotifications:e.maxDailyNotifications.toString()}),[h,m]=(0,i.useState)({}),[u,g]=(0,i.useState)(!1),[x,f]=(0,i.useState)(!1),p=(e,t)=>{switch(e){case"cooldownMinutes":if(!t||"string"!=typeof t)return"Cooldown minutes is required";let s=parseInt(t);if(isNaN(s))return"Cooldown must be a valid number";if(s<1)return"Cooldown must be at least 1 minute";if(s>1440)return"Cooldown cannot exceed 1440 minutes (24 hours)";return;case"maxDailyNotifications":if(!t||"string"!=typeof t)return"Max daily notifications is required";let r=parseInt(t);if(isNaN(r))return"Max daily notifications must be a valid number";if(r<1)return"Must allow at least 1 notification per day";if(r>100)return"Cannot exceed 100 notifications per day";return;default:return}},b=(e,t)=>{if(d(s=>({...s,[e]:t})),f(!0),h[e]&&m(t=>({...t,[e]:void 0})),"cooldownMinutes"===e||"maxDailyNotifications"===e){let s=p(e,t);s&&m(t=>({...t,[e]:s}))}},N=()=>{let e={},t=p("cooldownMinutes",c.cooldownMinutes);t&&(e.cooldownMinutes=t);let s=p("maxDailyNotifications",c.maxDailyNotifications);return s&&(e.maxDailyNotifications=s),m(e),0===Object.keys(e).length},y=async e=>{if(e.preventDefault(),N()){g(!0),m({});try{let e={enabledGlobally:c.enabledGlobally,cooldownMinutes:parseInt(c.cooldownMinutes),maxDailyNotifications:parseInt(c.maxDailyNotifications)},s=await E.updateSettings(e);t(s)}catch(e){console.error("Error saving settings:",e),m({general:e instanceof Error?e.message:"Failed to save settings"})}finally{g(!1)}}};return(0,a.jsxs)(o.Zb,{children:[(0,a.jsxs)(o.Ol,{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification Settings"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Configure global notification behavior and rate limiting"})]}),a.jsx(o.aY,{children:(0,a.jsxs)("form",{onSubmit:y,className:"space-y-6",children:[h.general&&a.jsx("div",{className:"p-3 rounded-md bg-danger/10 border border-danger/20",children:a.jsx("p",{className:"text-sm text-danger",children:h.general})}),a.jsx(l.SP,{label:"Global Notifications",helperText:"Master switch to enable or disable all notifications system-wide",children:(0,a.jsxs)(l.Ph,{value:c.enabledGlobally?"enabled":"disabled",onChange:e=>b("enabledGlobally","enabled"===e.target.value),disabled:u||r,children:[a.jsx("option",{value:"enabled",children:"âœ… Enabled - Notifications will be sent"}),a.jsx("option",{value:"disabled",children:"âŒ Disabled - All notifications paused"})]})}),(0,a.jsxs)(l.SP,{label:"Cooldown Period",error:h.cooldownMinutes,helperText:"Minimum time between notifications for the same trigger (1-1440 minutes)",required:!0,children:[(0,a.jsxs)("div",{className:"relative",children:[a.jsx(l.II,{type:"number",min:"1",max:"1440",value:c.cooldownMinutes,onChange:e=>b("cooldownMinutes",e.target.value),placeholder:"15",error:!!h.cooldownMinutes,disabled:u||r,className:"pr-20"}),a.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm",children:"minutes"})]}),(0,a.jsxs)("div",{className:"mt-1 text-xs text-slate-500",children:["Current: ",parseInt(c.cooldownMinutes)||0," minutes",parseInt(c.cooldownMinutes)>=60&&` (${Math.floor(parseInt(c.cooldownMinutes)/60)}h ${parseInt(c.cooldownMinutes)%60}m)`]})]}),a.jsx(l.SP,{label:"Daily Notification Limit",error:h.maxDailyNotifications,helperText:"Maximum notifications per trigger per day (1-100)",required:!0,children:(0,a.jsxs)("div",{className:"relative",children:[a.jsx(l.II,{type:"number",min:"1",max:"100",value:c.maxDailyNotifications,onChange:e=>b("maxDailyNotifications",e.target.value),placeholder:"10",error:!!h.maxDailyNotifications,disabled:u||r,className:"pr-16"}),a.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm",children:"per day"})]})}),(0,a.jsxs)("div",{className:"p-4 rounded-lg bg-slate-800/50 border border-slate-700",children:[a.jsx("h4",{className:"text-sm font-medium text-white mb-3",children:"Settings Preview"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-slate-400",children:"Status:"}),a.jsx("span",{className:c.enabledGlobally?"text-success":"text-slate-400",children:c.enabledGlobally?"Notifications Enabled":"Notifications Disabled"})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-slate-400",children:"Cooldown:"}),(0,a.jsxs)("span",{className:"text-slate-300",children:[parseInt(c.cooldownMinutes)||0," minutes between notifications"]})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-slate-400",children:"Daily Limit:"}),(0,a.jsxs)("span",{className:"text-slate-300",children:[parseInt(c.maxDailyNotifications)||0," notifications per trigger per day"]})]})]})]}),(0,a.jsxs)("div",{className:"flex gap-3 pt-4",children:[a.jsx(n.z,{type:"submit",isLoading:u,disabled:r||!x||Object.keys(h).length>0,className:"flex-1",children:u?"Saving...":"Save Settings"}),a.jsx(n.z,{type:"button",variant:"secondary",onClick:()=>{window.confirm("Reset all settings to default values?")&&(d({enabledGlobally:!0,cooldownMinutes:"15",maxDailyNotifications:"10"}),f(!0),m({}))},disabled:u||r,children:"Reset"}),a.jsx(n.z,{type:"button",variant:"ghost",onClick:()=>{(!x||window.confirm("You have unsaved changes. Are you sure you want to cancel?"))&&s()},disabled:u||r,children:"Cancel"})]})]})})]})}var W=s(59675);let U=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"}))}),J=i.forwardRef(function({title:e,titleId:t,...s},r){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:r,"aria-labelledby":t},s),e?i.createElement("title",{id:t},e):null,i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z"}),i.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"}))});function B({simulatorId:e,simulatorName:t}){let[s,r]=(0,i.useState)([]),[l,c]=(0,i.useState)(null),[d,h]=(0,i.useState)(!0),[m,u]=(0,i.useState)(null),[g,x]=(0,i.useState)("triggers"),[f,p]=(0,i.useState)(null),[b,N]=(0,i.useState)(null),[y,w]=(0,i.useState)(null),j=async()=>{try{h(!0),u(null);let[t,s,a]=await Promise.all([E.getTriggersBySimulator(e),E.getSettings(),E.getSystemStatus()]);r(t),c(s),w(a)}catch(e){console.error("Error loading notification data:",e),u(e instanceof Error?e.message:"Failed to load notification data")}finally{h(!1)}},v=async e=>{b?r(t=>t.map(t=>t.id===e.id?e:t)):r(t=>[...t,e]),p(null),N(null),w(await E.getSystemStatus())},S=async e=>{try{await E.deleteTrigger(e),r(t=>t.filter(t=>t.id!==e));let t=await E.getSystemStatus();w(t)}catch(e){console.error("Error deleting trigger:",e),alert("Failed to delete trigger: "+(e instanceof Error?e.message:"Unknown error"))}},A=async(e,t)=>{try{let s=await E.toggleTrigger(e,t);r(t=>t.map(t=>t.id===e?s:t));let a=await E.getSystemStatus();w(a)}catch(e){console.error("Error toggling trigger:",e),alert("Failed to update trigger: "+(e instanceof Error?e.message:"Unknown error"))}},R=async e=>{c(e),p(null),w(await E.getSystemStatus())},O=()=>{p(null),N(null)};return d?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),a.jsx("p",{className:"text-slate-400",children:"Loading notification system..."})]})}):m?a.jsx(o.Zb,{children:(0,a.jsxs)(o.aY,{className:"p-8 text-center",children:[a.jsx(L.Z,{className:"h-12 w-12 text-danger mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-white mb-2",children:"Error Loading Notifications"}),a.jsx("p",{className:"text-slate-400 mb-4",children:m}),a.jsx(n.z,{onClick:j,variant:"secondary",children:"Try Again"})]})}):(0,a.jsxs)("div",{className:"space-y-6",children:[a.jsx(o.Zb,{children:a.jsx(o.Ol,{children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[a.jsx(W.Z,{className:"h-6 w-6"}),"WhatsApp Notifications"]}),a.jsx("p",{className:"text-slate-400 mt-1",children:t?`Manage notifications for ${t}`:`Simulator: ${e}`})]}),y&&(0,a.jsxs)("div",{className:"flex items-center gap-4 text-sm",children:[(0,a.jsxs)("div",{className:(0,C.Z)("flex items-center gap-1.5 px-2 py-1 rounded-full border",y.whatsappReady?"bg-success/10 text-success border-success/20":"bg-danger/10 text-danger border-danger/20"),children:[y.whatsappReady?a.jsx(I.Z,{className:"h-3 w-3"}):a.jsx(L.Z,{className:"h-3 w-3"}),"WhatsApp ",y.whatsappReady?"Ready":"Not Ready"]}),(0,a.jsxs)("div",{className:(0,C.Z)("flex items-center gap-1.5 px-2 py-1 rounded-full border",y.notificationsEnabled?"bg-primary/10 text-primary border-primary/20":"bg-slate-700/50 text-slate-400 border-slate-700"),children:[a.jsx(W.Z,{className:"h-3 w-3"}),y.notificationsEnabled?"Enabled":"Disabled"]}),(0,a.jsxs)("div",{className:"text-slate-400",children:[y.activeTriggers," / ",y.totalTriggers," active"]})]})]})})}),a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-0",children:(0,a.jsxs)("div",{className:"flex border-b border-slate-700",children:[(0,a.jsxs)("button",{onClick:()=>x("triggers"),className:(0,C.Z)("flex-1 px-6 py-4 text-sm font-medium transition-colors","triggers"===g?"text-primary border-b-2 border-primary bg-primary/5":"text-slate-400 hover:text-white"),children:["Triggers (",s.length,")"]}),a.jsx("button",{onClick:()=>x("history"),className:(0,C.Z)("flex-1 px-6 py-4 text-sm font-medium transition-colors","history"===g?"text-primary border-b-2 border-primary bg-primary/5":"text-slate-400 hover:text-white"),children:"History"}),a.jsx("button",{onClick:()=>x("settings"),className:(0,C.Z)("flex-1 px-6 py-4 text-sm font-medium transition-colors","settings"===g?"text-primary border-b-2 border-primary bg-primary/5":"text-slate-400 hover:text-white"),children:"Settings"})]})})}),"triggers"===g&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification Triggers"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Configure when to send WhatsApp notifications based on energy usage thresholds"})]}),(0,a.jsxs)(n.z,{onClick:()=>{N(null),p("create")},className:"flex items-center gap-2",children:[a.jsx(U,{className:"h-4 w-4"}),"Add Trigger"]})]}),a.jsx(M,{triggers:s,onEdit:e=>{N(e),p("edit")},onDelete:S,onToggle:A,isLoading:d})]}),"history"===g&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification History"}),a.jsx("p",{className:"text-sm text-slate-400",children:"View all sent and failed notifications for this simulator"})]}),a.jsx(H,{simulatorId:e})]}),"settings"===g&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-white",children:"Notification Settings"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Configure global notification behavior and rate limiting"})]}),(0,a.jsxs)(n.z,{variant:"ghost",onClick:()=>p("settings"),className:"flex items-center gap-2",children:[a.jsx(J,{className:"h-4 w-4"}),"Edit Settings"]})]}),l&&a.jsx(o.Zb,{children:a.jsx(o.aY,{className:"p-6",children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsxs)("div",{children:[a.jsx("h4",{className:"text-sm font-medium text-white mb-2",children:"Global Status"}),a.jsx("p",{className:(0,C.Z)("text-sm",l.enabledGlobally?"text-success":"text-slate-400"),children:l.enabledGlobally?"Notifications Enabled":"Notifications Disabled"})]}),(0,a.jsxs)("div",{children:[a.jsx("h4",{className:"text-sm font-medium text-white mb-2",children:"Cooldown Period"}),(0,a.jsxs)("p",{className:"text-sm text-slate-300",children:[l.cooldownMinutes," minutes"]})]}),(0,a.jsxs)("div",{children:[a.jsx("h4",{className:"text-sm font-medium text-white mb-2",children:"Daily Limit"}),(0,a.jsxs)("p",{className:"text-sm text-slate-300",children:[l.maxDailyNotifications," per trigger"]})]})]})})})]}),("create"===f||"edit"===f)&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsx("div",{className:"w-full max-w-md",children:a.jsx(T,{simulatorId:e,trigger:b||void 0,onSave:v,onCancel:O,isLoading:!1})})}),"settings"===f&&l&&a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsx("div",{className:"w-full max-w-md",children:a.jsx($,{settings:l,onSave:R,onCancel:O})})})]})}},29752:(e,t,s)=>{s.d(t,{Ol:()=>o,Zb:()=>l,aY:()=>c});var r=s(10326),a=s(17577),i=s(41135);let n={default:"bg-slate-900/60",elevated:"bg-slate-900 shadow-lg",interactive:"cursor-pointer hover:border-primary-700 hover:shadow-lg",flat:"shadow-none"},l=(0,a.forwardRef)(({className:e,variant:t="default",...s},a)=>r.jsx("div",{ref:a,className:(0,i.Z)("rounded-xl border border-slate-800 backdrop-blur-sm shadow-md transition-shadow duration-200",n[t],e),...s}));l.displayName="Card";let o=(0,a.forwardRef)(({className:e,...t},s)=>r.jsx("div",{ref:s,className:(0,i.Z)("p-4 sm:p-6 border-b border-slate-800",e),...t}));o.displayName="CardHeader";let c=(0,a.forwardRef)(({className:e,...t},s)=>r.jsx("div",{ref:s,className:(0,i.Z)("p-4 sm:p-6",e),...t}));c.displayName="CardContent",(0,a.forwardRef)(({className:e,...t},s)=>r.jsx("div",{ref:s,className:(0,i.Z)("p-4 sm:p-6 border-t border-slate-800",e),...t})).displayName="CardFooter"},41190:(e,t,s)=>{s.d(t,{II:()=>l,Ph:()=>o,SP:()=>c});var r=s(10326),a=s(17577),i=s(41135),n=s(19381);let l=(0,a.forwardRef)(({className:e,error:t,success:s,...a},n)=>r.jsx("input",{className:(0,i.Z)("w-full rounded-md border px-3 py-2 text-sm text-white transition-colors duration-150","placeholder:text-slate-500","focus:outline-none focus:ring-2","disabled:opacity-50 disabled:cursor-not-allowed",t?"border-danger bg-danger/5 focus:border-danger focus:ring-danger/20":s?"border-success bg-success/5 focus:border-success focus:ring-success/20":"border-slate-800 bg-slate-950/60 focus:border-primary focus:ring-primary/20",e),ref:n,...a}));l.displayName="Input";let o=(0,a.forwardRef)(({className:e,error:t,success:s,children:a,...n},l)=>r.jsx("select",{className:(0,i.Z)("w-full rounded-md border px-3 py-2 text-sm text-white transition-colors duration-150","focus:outline-none focus:ring-2","disabled:opacity-50 disabled:cursor-not-allowed",t?"border-danger bg-danger/5 focus:border-danger focus:ring-danger/20":s?"border-success bg-success/5 focus:border-success focus:ring-success/20":"border-slate-800 bg-slate-950/60 focus:border-primary focus:ring-primary/20",e),ref:l,...n,children:a}));function c({label:e,error:t,helperText:s,required:a,children:i}){return(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsxs)("label",{className:"block text-sm font-medium text-slate-300",children:[e,a&&r.jsx("span",{className:"text-danger ml-1",children:"*"})]}),i,t&&(0,r.jsxs)("p",{className:"text-xs text-danger flex items-center gap-1",children:[r.jsx(n.Z,{className:"h-4 w-4","aria-hidden":"true"}),t]}),!t&&s&&r.jsx("p",{className:"text-xs text-slate-500",children:s})]})}o.displayName="Select"},94337:(e,t,s)=>{async function r(e){try{let t=await fetch("/api/whatsapp/send",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({to:e.to,message:e.message})});if(!t.ok){let e=await t.json().catch(()=>({}));return{success:!1,error:e.error||`Failed to send message: ${t.status} ${t.statusText}`}}let s=await t.json();return{success:s.success||!0,id:s.id,to:s.to,message:s.message||"Message sent successfully"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Network error occurred"}}}async function a(){try{let e=await fetch("/api/whatsapp/status",{method:"GET",headers:{Accept:"application/json"}}),t=await e.json();return{ready:!0===t.ready,hasQR:!0===t.hasQR}}catch(e){return{ready:!1,hasQR:!1}}}async function i(){try{let e=await fetch("/api/whatsapp/qr",{method:"GET",headers:{Accept:"application/json"}});return{qr:(await e.json()).qr||null}}catch(e){return{qr:null}}}s.d(t,{U3:()=>r,n_:()=>a,sE:()=>i})},59675:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(17577);let a=r.forwardRef(function({title:e,titleId:t,...s},a){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"}))})}};