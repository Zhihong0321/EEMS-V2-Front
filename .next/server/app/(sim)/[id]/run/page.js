(()=>{var e={};e.id=998,e.ids=[998],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},6325:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>x,tree:()=>d}),s(6512),s(5866),s(4337);var a=s(3191),r=s(8716),n=s(7922),i=s.n(n),l=s(5231),o={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>l[e]);s.d(t,o);let d=["",{children:["(sim)",{children:["[id]",{children:["run",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,6512)),"E:\\EEMS-Front\\src\\app\\(sim)\\[id]\\run\\page.tsx"]}]},{}]},{}]},{"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}]},{layout:[()=>Promise.resolve().then(s.bind(s,4337)),"E:\\EEMS-Front\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,5866,23)),"next/dist/client/components/not-found-error"]}],c=["E:\\EEMS-Front\\src\\app\\(sim)\\[id]\\run\\page.tsx"],u="/(sim)/[id]/run/page",m={require:s,loadChunk:()=>Promise.resolve()},x=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/(sim)/[id]/run/page",pathname:"/[id]/run",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},5993:(e,t,s)=>{Promise.resolve().then(s.bind(s,5894))},434:(e,t,s)=>{"use strict";s.d(t,{default:()=>r.a});var a=s(9404),r=s.n(a)},5894:(e,t,s)=>{"use strict";s.d(t,{SimulatorRunContent:()=>w});var a=s(326),r=s(7577),n=s(434);let i=r.forwardRef(function({title:e,titleId:t,...s},a){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z"}))}),l=r.forwardRef(function({title:e,titleId:t,...s},a){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z"}))}),o=r.forwardRef(function({title:e,titleId:t,...s},a){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"}))});var d=s(1135);let c=new Intl.NumberFormat(void 0,{maximumFractionDigits:0}),u=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"});function m({baseKw:e,onBaseKwChange:t,volatility:s,onVolatilityChange:r,isRunning:n,onStart:m,onStop:x,sentCount:p,lastSentAt:h,disabled:g,disabledReason:f}){let b=h?u.format(new Date(h)):"—";return(0,a.jsxs)("article",{className:"flex flex-col gap-6 rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,a.jsxs)("header",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-white",children:"Auto mode"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Emit one tick every 15 seconds with gaussian noise."})]}),a.jsx(i,{className:"h-8 w-8 text-cyan-500","aria-hidden":"true"})]}),(0,a.jsxs)("div",{className:"grid gap-4 sm:grid-cols-2",children:[(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm",children:[a.jsx("span",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Base kW"}),a.jsx("input",{type:"number",min:0,step:1,value:e,onChange:e=>{t(Number(e.target.value))},className:"w-full rounded-md border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-cyan-500 focus:outline-none"})]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm",children:[a.jsx("span",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Volatility %"}),a.jsx("input",{type:"number",min:0,max:100,step:1,value:s,onChange:e=>{r(Math.max(0,Math.min(100,Number(e.target.value))))},className:"w-full rounded-md border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-cyan-500 focus:outline-none"})]})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-400",children:[(0,a.jsxs)("p",{children:["Next tick interval: ",a.jsx("span",{className:"font-semibold text-slate-200",children:"15 seconds"})]}),(0,a.jsxs)("p",{className:"mt-1",children:["Expected power window: ",a.jsx("span",{className:"font-semibold text-slate-200",children:c.format(Math.max(0,Math.round(e*(1-s/100))))})," – "," ",a.jsx("span",{className:"font-semibold text-slate-200",children:c.format(Math.round(e*(1+s/100)))})," kW"]})]}),a.jsx("button",{type:"button",onClick:n?x:m,disabled:g,className:(0,d.Z)("inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",g?"cursor-not-allowed bg-slate-800/60 text-slate-500":n?"bg-danger/80 text-white hover:bg-danger":"bg-primary text-primary-foreground hover:bg-cyan-600"),children:n?(0,a.jsxs)(a.Fragment,{children:[a.jsx(l,{className:"h-4 w-4","aria-hidden":"true"})," Stop auto run"]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(o,{className:"h-4 w-4","aria-hidden":"true"})," Start auto run"]})}),g&&f?a.jsx("p",{className:"text-xs text-warning",children:f}):null,(0,a.jsxs)("dl",{className:"grid grid-cols-2 gap-4 rounded-lg border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-400",children:[(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-600",children:"Ticks sent"}),a.jsx("dd",{className:"mt-1 text-sm text-slate-200",children:p})]}),(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-600",children:"Last tick"}),a.jsx("dd",{className:"mt-1 text-sm text-slate-200",children:b})]})]})]})}let x=r.forwardRef(function({title:e,titleId:t,...s},a){return r.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":t},s),e?r.createElement("title",{id:t},e):null,r.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"}))}),p=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"});function h({sliderValue:e,onSliderChange:t,maxKw:s,onMaxKwChange:r,isRunning:n,onStart:i,onStop:o,sentCount:c,lastSentAt:u,disabled:m,disabledReason:h}){let g=Math.max(0,e*s),f=u?p.format(new Date(u)):"—";return(0,a.jsxs)("article",{className:"flex flex-col gap-6 rounded-2xl border border-slate-800 bg-slate-900/60 p-6",children:[(0,a.jsxs)("header",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[a.jsx("h2",{className:"text-xl font-semibold text-white",children:"Manual fast-forward"}),a.jsx("p",{className:"text-sm text-slate-400",children:"Emit one tick per second using the selected power multiplier."})]}),a.jsx(x,{className:"h-8 w-8 text-purple-400","aria-hidden":"true"})]}),(0,a.jsxs)("div",{className:"grid gap-4 sm:grid-cols-[minmax(0,2fr)_1fr]",children:[(0,a.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm",children:[a.jsx("span",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Adjust load multiplier"}),a.jsx("input",{type:"range",min:0,max:1,step:.01,value:e,onChange:e=>{t(Number(e.target.value))},className:"w-full"}),(0,a.jsxs)("span",{className:"text-xs text-slate-400",children:["FAST-FORWARD x15 — Multiplier ",(100*e).toFixed(0),"%"]})]}),(0,a.jsxs)("label",{className:"flex flex-col gap-2 text-sm",children:[a.jsx("span",{className:"text-xs uppercase tracking-[0.2em] text-slate-500",children:"Max power (kW)"}),a.jsx("input",{type:"number",min:0,step:5,value:s,onChange:e=>{r(Math.max(0,Number(e.target.value)))},className:"w-full rounded-md border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-white focus:border-purple-400 focus:outline-none"})]})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-400",children:[(0,a.jsxs)("p",{children:["Current output: ",a.jsx("span",{className:"font-semibold text-slate-200",children:g.toFixed(1)})," kW"]}),(0,a.jsxs)("p",{className:"mt-1",children:["Ticks are emitted every ",a.jsx("span",{className:"font-semibold text-slate-200",children:"1 second"})," with ",a.jsx("span",{className:"font-semibold text-slate-200",children:"sample_seconds=15"}),"."]})]})]}),a.jsx("button",{type:"button",onClick:n?o:i,disabled:m,className:(0,d.Z)("inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2",m?"cursor-not-allowed bg-slate-800/60 text-slate-500":n?"bg-danger/80 text-white hover:bg-danger":"bg-primary text-primary-foreground hover:bg-cyan-600"),children:n?(0,a.jsxs)(a.Fragment,{children:[a.jsx(l,{className:"h-4 w-4","aria-hidden":"true"})," Stop manual run"]}):(0,a.jsxs)(a.Fragment,{children:[a.jsx(x,{className:"h-4 w-4","aria-hidden":"true"})," Start manual run"]})}),m&&h?a.jsx("p",{className:"text-xs text-warning",children:h}):null,(0,a.jsxs)("dl",{className:"grid grid-cols-2 gap-4 rounded-lg border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-400",children:[(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-600",children:"Ticks sent"}),a.jsx("dd",{className:"mt-1 text-sm text-slate-200",children:c})]}),(0,a.jsxs)("div",{children:[a.jsx("dt",{className:"uppercase tracking-[0.2em] text-slate-600",children:"Last tick"}),a.jsx("dd",{className:"mt-1 text-sm text-slate-200",children:f})]})]})]})}var g=s(8069),f=s(1004);function b({simulatorId:e,intervalMs:t,mode:s,getTick:a}){let{push:n}=(0,f.p)(),[i,l]=(0,r.useState)(!1),[o,d]=(0,r.useState)(0),[c,u]=(0,r.useState)(void 0),m=(0,r.useRef)(null),x=(0,r.useRef)(0),p=(0,r.useRef)(()=>{}),h=(0,r.useCallback)(()=>{m.current&&(clearInterval(m.current),m.current=null),l(!1)},[]),b=(0,r.useCallback)(async()=>{if(!e)return;let t=a();try{await (0,g.M8)({simulator_id:e,mode:s,ticks:[t]}),x.current=0,d(e=>e+1),u(new Date().toISOString());let a=`recent_ticks_${e}`,r=JSON.parse(localStorage.getItem(a)||"[]");r.push({ts:Date.now(),...t}),r.length>180&&r.shift(),localStorage.setItem(a,JSON.stringify(r))}catch(t){x.current+=1;let e=t instanceof Error?t.message:"Failed to deliver reading";1===x.current&&n({title:"Reading delivery failed",description:e,variant:"error"}),x.current>=3&&(h(),n({title:"Emitter paused",description:`Stopped ${s} emitter after repeated failures.`,variant:"error",action:{label:"Retry now",onClick:()=>p.current()}}))}},[a,s,n,e,h]);return{isRunning:i,sentCount:o,lastSentAt:c,start:(0,r.useCallback)(()=>{if(!e){n({title:"No simulator selected",description:"Create or pick a simulator before sending readings.",variant:"error"});return}m.current||(x.current=0,l(!0),b(),m.current=setInterval(()=>{b()},t))},[t,n,b,e]),stop:h}}function w({simulatorId:e,simulatorName:t,targetKwh:s}){var i;let[l,o]=(0,r.useState)(320),[d,c]=(0,r.useState)(12),[u,x]=(0,r.useState)(.5),[p,g]=(0,r.useState)(800),f=(0,r.useMemo)(()=>u*p,[u,p]),w=b({simulatorId:e,intervalMs:1e3,mode:"auto",getTick:(0,r.useCallback)(()=>({power_kw:Number(Math.max(0,l*(1+Math.max(0,Math.min(d,100))/100*(2*Math.random()-1))).toFixed(3)),sample_seconds:30,device_ts:new Date().toISOString()}),[l,d])}),j=(i=()=>f,b({simulatorId:e,intervalMs:1e3,mode:"manual",getTick:(0,r.useCallback)(()=>({power_kw:Number(Math.max(0,i()).toFixed(3)),sample_seconds:30,device_ts:new Date().toISOString()}),[i])})),v=()=>{w.isRunning?w.stop():(j.stop(),w.start())},N=()=>{j.isRunning?j.stop():(w.stop(),j.start())};return(0,a.jsxs)("section",{className:"space-y-10",children:[(0,a.jsxs)("header",{className:"flex flex-wrap items-end justify-between gap-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-slate-500",children:"Simulator controls"}),a.jsx("h1",{className:"text-3xl font-semibold text-white",children:t}),a.jsx("p",{className:"text-sm text-slate-400",children:"Configure auto and manual emitters. Only one mode can run at a time to avoid duplicate ticks."}),(0,a.jsxs)("p",{className:"text-xs text-slate-500",children:["Target block: ",s?`${s} kWh`:"—"," \xb7 Timezone ","Asia/Kuala_Lumpur"]})]}),a.jsx(n.default,{href:{pathname:"/sim/[id]",query:{id:e}},className:"inline-flex items-center rounded-md border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-500 hover:text-white",children:"Back to dashboard"})]}),(0,a.jsxs)("div",{className:"grid gap-6 lg:grid-cols-2",children:[a.jsx(m,{baseKw:l,onBaseKwChange:o,volatility:d,onVolatilityChange:c,isRunning:w.isRunning,onStart:v,onStop:v,sentCount:w.sentCount,lastSentAt:w.lastSentAt,disabled:j.isRunning,disabledReason:j.isRunning?"Manual emitter is active. Stop it before running auto mode.":void 0}),a.jsx(h,{sliderValue:u,onSliderChange:x,maxKw:p,onMaxKwChange:g,isRunning:j.isRunning,onStart:N,onStop:N,sentCount:j.sentCount,lastSentAt:j.lastSentAt,disabled:w.isRunning,disabledReason:w.isRunning?"Auto emitter is active. Stop it before running manual mode.":void 0})]}),(0,a.jsxs)("p",{className:"text-xs text-slate-500",children:["Auto mode sends gaussianised readings every 15 seconds; manual fast-forward emits every second with ",a.jsx("code",{className:"rounded bg-slate-800 px-1 py-0.5",children:"sample_seconds=30"})," so the backend advances by 30 seconds per tick (30x speed)."]})]})}},6512:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var a=s(9510),r=s(8570);let n=(0,r.createProxy)(String.raw`E:\EEMS-Front\src\components\run\simulator-run-content.tsx`),{__esModule:i,$$typeof:l}=n;n.default;let o=(0,r.createProxy)(String.raw`E:\EEMS-Front\src\components\run\simulator-run-content.tsx#SimulatorRunContent`);var d=s(9905);async function c({params:e}){let t;let s=e.id,r=`Simulator ${s}`;try{let e=(await (0,d.Mf)()).find(e=>e.id===s);e&&(r=e.name,t=e.target_kwh)}catch(e){console.error("Failed to load simulator metadata",e)}return a.jsx(o,{simulatorId:s,simulatorName:r,targetKwh:t})}},9905:(e,t,s)=>{"use strict";s.d(t,{QY:()=>x,lA:()=>m,Mf:()=>u}),process.env.NEXT_PUBLIC_BACKEND_WRITE_TOKEN,process.env.NEXT_PUBLIC_BACKEND_KEY,process.env.NEXT_PUBLIC_BACKEND_API_KEY;let a="/api/bridge",r=new Set([429,500,502,503,504]);class n extends Error{constructor(e,t,s,a){super(e),this.status=t,this.code=s,this.details=a}}async function i(e){let t=await e.text();if(t)try{return JSON.parse(t)}catch(t){throw new n(`Invalid JSON response: ${t.message}`,e.status)}}async function l(e){let t;try{t=await e.clone().json()}catch{}if(!t)try{let t=await e.text();if(t)return new n(t,e.status)}catch{}let s=t?.error?.message??t?.message??e.statusText??`Request failed with status ${e.status}`,a=t?.error?.code,r=t?.error?.details;if(t&&t.detail){r=t.detail;try{if(Array.isArray(t.detail)){let e=t.detail.map(e=>e?.msg||e?.detail||"Validation error").filter(Boolean);e.length>0&&(s=e.join("; "))}else"string"==typeof t.detail&&(s=t.detail)}catch{}}return new n(s,e.status,a,r)}function o(e){return new Promise(t=>setTimeout(t,e))}async function d(e,t,s={}){let d=function(e){if(!a)throw new n("Backend base URL is not configured.",0);return e.startsWith("http")?e:`${a}${e}`}(e);d=`http://localhost${d}`;let c=s.retryDelays??[],u=0,m=new Headers(t?.headers);m.set("Accept","application/json");let x={...t,headers:m};for(;;)try{let e=await fetch(d,x);if(!e.ok){var p;let t=await l(e);if(p=e.status,r.has(p)&&u<c.length){await o(c[u++]);continue}throw t}if(204===e.status)return;return await i(e)}catch(e){if(e instanceof n)throw e;if(u<c.length){await o(c[u++]);continue}throw e}}async function c(e,t){try{return await d(e,t)}catch(s){if(!(s instanceof n))return await d(e,t,{retryDelays:[500]});throw s}}async function u(){let e=await c("/api/v1/simulators");return Array.isArray(e)?e:e.data??[]}async function m(e){return await c(`/api/v1/blocks/latest?simulator_id=${encodeURIComponent(e)}`)}async function x(e,t=10){let s=await c(`/api/v1/blocks/history?simulator_id=${encodeURIComponent(e)}&limit=${t}`);return Array.isArray(s)?s:s.data??[]}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[948,485,162],()=>s(6325));module.exports=a})();